<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Bootstrap 5 Page - Modern Design Refresh</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bs-primary: #F97316;
            --bs-primary-rgb: 249, 115, 22;
            --bs-primary-dark: #EA580C;
            --bs-primary-light: #FB923C;
            --bs-body-font-family: 'Inter', 'Sarabun', sans-serif;
            --bs-body-bg: #f8fafc; /* Fallback color */
            --bs-border-color: #e2e8f0;
        }

        body {
            font-size: 1rem;
            line-height: 1.6;
            background-color: var(--bs-body-bg);
            background-image: radial-gradient(var(--bs-border-color) 1px, transparent 1px);
            background-size: 1.5rem 1.5rem;
            background-attachment: fixed;
        }

        .btn-primary {
            --bs-btn-bg: var(--bs-primary);
            --bs-btn-border-color: var(--bs-primary);
            --bs-btn-hover-bg: var(--bs-primary-dark);
            --bs-btn-hover-border-color: var(--bs-primary-dark);
            --bs-btn-active-bg: var(--bs-primary-dark);
            --bs-btn-active-border-color: var(--bs-primary-dark);
            --bs-btn-focus-shadow-rgb: var(--bs-primary-rgb);
        }

        .content-section {
            background-color: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid var(--bs-border-color);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
        }
        .form-label {
            font-weight: 500;
            color: #475569;
            font-size: 0.95rem;
        }
        .address-card, .employee-card {
            background-color: #f8fafc;
            border: 1px solid var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            transition: all 0.3s ease-in-out;
        }
        .employee-card.highlight {
            background-color: #fffbeb;
            border-color: var(--bs-primary-light);
            box-shadow: 0 0 0 2px var(--bs-primary-light);
        }
        .address-card p, .employee-card p {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 0.25rem;
        }
        .address-card p.small, .employee-card p.small {
            font-size: 0.85rem;
        }
        select:disabled, input:disabled, textarea:disabled, input:read-only, textarea:read-only {
            background-color: #e9ecef;
        }
        
        .main-layout {
            display: flex;
            min-height: 100vh;
        }

        #sidebar {
            width: 260px;
            background-color: #ffffff;
            box-shadow: 0 1px 3px rgba(0,0,0,.05);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        #sidebar .navbar-brand {
            font-weight: 700;
            color: var(--bs-primary);
            margin-bottom: 2rem;
            text-align: center;
            font-size: 1.75rem !important;
        }

        #sidebar .list-group-item {
            border: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #475569;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-size: 0.95rem;
        }

        #sidebar .list-group-item.active {
            background-color: var(--bs-primary-light);
            color: #ffffff;
            background-image: linear-gradient(to right, var(--bs-primary-light), var(--bs-primary));
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.2), 0 2px 4px -2px rgba(249, 115, 22, 0.2);
        }
        
        #sidebar .list-group-item:hover:not(.active) {
            background-color: #f1f5f9;
            color: #1e293b;
        }
        
        #sidebar .list-group-item .badge {
            transition: background-color 0.3s ease;
        }

        #main-content {
            flex-grow: 1;
            padding: 2.5rem;
            overflow-y: auto;
        }

        .table thead {
            --bs-table-bg: #f8fafc;
            color: #64748b;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        .table tbody td {
            font-size: 0.9rem;
        }

        h2 {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.75rem;
        }
        h5.modal-title, h5.card-title {
            font-size: 1.15rem;
        }
        .notification-item {
            border-left-width: 4px;
            border-left-style: solid;
            padding: 0.75rem 1rem;
        }
        .notification-item > .d-flex {
            align-items: center !important;
        }
        .notification-item .alert-heading {
            font-size: 1rem;
            margin-bottom: 0.1rem !important;
        }
        .notification-item p {
            font-size: 0.85rem;
            margin-bottom: 0.1rem !important;
        }
        .notification-item .badge {
            font-size: 0.7rem;
        }
        .alert-secondary.notification-item { border-left-color: var(--bs-secondary); }
        .alert-warning.notification-item { border-left-color: var(--bs-warning); }
        .alert-danger.notification-item { border-left-color: var(--bs-danger); }
        .alert-dark.notification-item { border-left-color: var(--bs-dark); }
        .alert-info.notification-item { border-left-color: var(--bs-info); }
        
        .nav-tabs .nav-link {
            color: #64748b;
        }
        .nav-tabs .nav-link.active {
            color: var(--bs-primary);
            border-color: var(--bs-primary);
            border-bottom-color: transparent;
        }
        .flag-icon {
            width: 20px;
            height: auto;
            margin-left: 8px;
            vertical-align: middle;
        }
        .native-lang {
            font-size: 0.9em;
            color: #64748b;
            margin-left: 4px;
        }
        .employee-photo-thumb {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 50%;
            margin-right: 1rem;
            background-color: #e2e8f0;
        }
        .employee-photo-preview {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 0.5rem;
            border: 1px solid var(--bs-border-color);
            background-color: #f8fafc;
        }
        .file-upload-display {
            font-size: 0.85rem;
        }
        .file-upload-display a {
            font-weight: 500;
        }
        .step-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            background-color: #f8fafc;
            border: 1px solid var(--bs-border-color);
        }
        .step-item.completed {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
        }
    </style>
</head>
<body>

    <div class="main-layout">
        <aside id="sidebar">
            <a class="navbar-brand fs-4" href="#"><i class="bi bi-building-fill-gear"></i> Company Records</a>
            <div class="list-group" id="main-nav">
                <a href="#dashboard-pane" class="list-group-item list-group-item-action" data-bs-toggle="pane"><i class="bi bi-pie-chart-fill me-2"></i>ภาพรวม</a>
                <a href="#notification-pane" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-tab-target="90day-tab">
                    <span><i class="bi bi-bell-fill me-2"></i>แจ้งเตือน</span>
                    <span class="badge bg-danger rounded-pill" id="notification-total-badge" style="display: none;"></span>
                </a>
                <hr>
                <a href="#employer-system-pane" id="nav-employer-system-pane" class="list-group-item list-group-item-action active" data-bs-toggle="pane"><i class="bi bi-person-vcard-fill me-2"></i>ข้อมูลนายจ้าง</a>
                <a href="#importer-system-pane" class="list-group-item list-group-item-action" data-bs-toggle="pane"><i class="bi bi-box-arrow-in-down-left me-2"></i>ข้อมูลบริษัทนำเข้า</a>
                <a href="#agent-system-pane" class="list-group-item list-group-item-action" data-bs-toggle="pane"><i class="bi bi-person-square me-2"></i>ข้อมูลเอเจนซี่</a>
                <a href="#delegate-system-pane" class="list-group-item list-group-item-action" data-bs-toggle="pane"><i class="bi bi-people-fill me-2"></i>ข้อมูลพนักงาน</a>
            </div>
        </aside>

        <main id="main-content">
            <div id="pageSuccessMessage" class="alert alert-success d-none mb-4" role="alert"></div>

            <div id="dashboard-pane" class="content-pane" style="display: none;">
                <div class="p-4 p-md-5 content-section">
                    <h2 class="mb-4">ภาพรวมระบบ (Dashboard)</h2>
                    <div class="d-flex flex-wrap gap-2 mb-4 p-3 bg-light border rounded">
    <div>
        <label for="db-year-select" class="form-label form-label-sm">เลือกปี</label>
        <select id="db-year-select" class="form-select form-select-sm"></select>
    </div>
    <div>
        <label for="db-month-select" class="form-label form-label-sm">เลือกเดือน (สำหรับสรุป)</label>
        <select id="db-month-select" class="form-select form-select-sm">
            <option value="all">ดูทั้งปี</option>
        </select>
    </div>
    <div>
        <label for="db-compare-month-select" class="form-label form-label-sm">เปรียบเทียบกับเดือน</label>
        <select id="db-compare-month-select" class="form-select form-select-sm">
            <option value="">ไม่ต้องเปรียบเทียบ</option>
        </select>
    </div>
</div>
                    <div class="row g-4 mb-4">
                        <div class="col-lg-4 col-md-6">
                            <div class="card text-bg-primary h-100">
                                <div class="card-body d-flex flex-column justify-content-center">
                                    <h5 class="card-title"><i class="bi bi-building me-2"></i>นายจ้างทั้งหมด</h5>
                                    <p class="display-4 fw-bold" id="db-total-employers">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="card text-bg-info h-100">
                                <div class="card-body d-flex flex-column justify-content-center">
                                    <h5 class="card-title"><i class="bi bi-people-fill me-2"></i>พนักงานทั้งหมด</h5>
                                    <p class="display-4 fw-bold" id="db-total-employees">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="card text-bg-danger h-100">
                                <div class="card-body d-flex flex-column justify-content-center">
                                    <h5 class="card-title"><i class="bi bi-bell-fill me-2"></i>การแจ้งเตือน</h5>
                                    <p class="display-4 fw-bold" id="db-total-notifications">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">สรุปพนักงานตามสัญชาติ</h5>
                                    <div style="height: 350px;">
                                        <canvas id="nationalityChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">สรุปพนักงานตามประเภท MOU</h5>
                                    <div style="height: 350px;">
                                        <canvas id="mouChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                             <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">ภาพรวมรายการที่จะหมดอายุใน 12 เดือนข้างหน้า</h5>
                                    <div style="height: 350px;">
                                        <canvas id="expiryChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="notification-pane" class="content-pane" style="display: none;">
                <div class="p-4 p-md-5 content-section">
                    <h2 class="mb-4">รายการแจ้งเตือน</h2>
                    <ul class="nav nav-tabs" id="notificationTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="90day-tab" data-bs-toggle="tab" data-bs-target="#n-90day" type="button" role="tab">
                                รายงานตัว 90 วัน <span class="badge bg-danger rounded-pill ms-1" id="notification-90day-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="passport-tab" data-bs-toggle="tab" data-bs-target="#n-passport" type="button" role="tab">
                                Passport <span class="badge bg-danger rounded-pill ms-1" id="notification-passport-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="permits-tab" data-bs-toggle="tab" data-bs-target="#n-permits" type="button" role="tab">
                                ใบอนุญาต/วีซ่า <span class="badge bg-danger rounded-pill ms-1" id="notification-permits-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ci-renew-tab" data-bs-toggle="tab" data-bs-target="#n-ci-renew" type="button" role="tab">
                                ต่ออายุ CI <span class="badge bg-danger rounded-pill ms-1" id="notification-ci_renew-badge">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resolution-renew-tab" data-bs-toggle="tab" data-bs-target="#n-resolution-renew" type="button" role="tab">
                                ต่ออายุมติ <span class="badge bg-danger rounded-pill ms-1" id="notification-resolution_renew-badge">0</span>
                            </button>
                        </li>
                         <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cancelled-renew-tab" data-bs-toggle="tab" data-bs-target="#n-cancelled-renew" type="button" role="tab">
                                รายการที่ยกเลิก <span class="badge bg-secondary rounded-pill ms-1" id="notification-cancelled_renew-badge">0</span>
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content pt-4" id="notificationTabContent">
                        <div class="tab-pane fade show active" id="n-90day" role="tabpanel">
                            <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <input type="text" class="form-control form-control-sm w-auto" id="search-90day-input" placeholder="ค้นหา...">
                                <select class="form-select form-select-sm w-auto" id="search-90day-nationality"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-90day-mou"><option value="">-- ทุกประเภท มติ. --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option>อื่นๆ</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-90day-month">
                                    <option value="">-- ทุกเดือน --</option>
                                    <option value="0">มกราคม</option><option value="1">กุมภาพันธ์</option><option value="2">มีนาคม</option><option value="3">เมษายน</option><option value="4">พฤษภาคม</option><option value="5">มิถุนายน</option><option value="6">กรกฎาคม</option><option value="7">สิงหาคม</option><option value="8">กันยายน</option><option value="9">ตุลาคม</option><option value="10">พฤศจิกายน</option><option value="11">ธันวาคม</option>
                                </select>
                                <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="90day"><i class="bi bi-download me-1"></i> Export</button>
                            </div>
                             <h5 class="mb-3">รายการรายงานตัว 90 วัน (<span id="90dayCount">0</span>)</h5>
                             <div id="notification90DayListContainer" class="vstack gap-2"></div>
                             <nav id="pagination-90day-controls" class="mt-4"></nav>
                        </div>
                        <div class="tab-pane fade" id="n-passport" role="tabpanel">
                             <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <input type="text" class="form-control form-control-sm w-auto" id="search-passport-input" placeholder="ค้นหา...">
                                <select class="form-select form-select-sm w-auto" id="search-passport-nationality"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-passport-mou"><option value="">-- ทุกประเภท มติ. --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option>อื่นๆ</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-passport-month">
                                    <option value="">-- ทุกเดือน --</option>
                                    <option value="0">มกราคม</option><option value="1">กุมภาพันธ์</option><option value="2">มีนาคม</option><option value="3">เมษายน</option><option value="4">พฤษภาคม</option><option value="5">มิถุนายน</option><option value="6">กรกฎาคม</option><option value="7">สิงหาคม</option><option value="8">กันยายน</option><option value="9">ตุลาคม</option><option value="10">พฤศจิกายน</option><option value="11">ธันวาคม</option>
                                </select>
                                <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="passport"><i class="bi bi-download me-1"></i> Export</button>
                            </div>
                             <h5 class="mb-3">รายการ Passport หมดอายุ (<span id="passportCount">0</span>)</h5>
                             <div id="notificationPassportListContainer" class="vstack gap-2"></div>
                             <nav id="pagination-passport-controls" class="mt-4"></nav>
                        </div>
                        <div class="tab-pane fade" id="n-permits" role="tabpanel">
                             <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <input type="text" class="form-control form-control-sm w-auto" id="search-permits-input" placeholder="ค้นหา...">
                                <select class="form-select form-select-sm w-auto" id="search-permits-nationality"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-permits-mou"><option value="">-- ทุกประเภท มติ. --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option>อื่นๆ</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-permits-month">
                                    <option value="">-- ทุกเดือน --</option>
                                    <option value="0">มกราคม</option><option value="1">กุมภาพันธ์</option><option value="2">มีนาคม</option><option value="3">เมษายน</option><option value="4">พฤษภาคม</option><option value="5">มิถุนายน</option><option value="6">กรกฎาคม</option><option value="7">สิงหาคม</option><option value="8">กันยายน</option><option value="9">ตุลาคม</option><option value="10">พฤศจิกายน</option><option value="11">ธันวาคม</option>
                                </select>
                            </div>
                            <div class="row g-4">
                                <div class="col-lg-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">ใบอนุญาตทำงานใกล้หมดอายุ (<span id="workPermitCount">0</span>)</h5>
                                        <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="workPermit"><i class="bi bi-download"></i></button>
                                    </div>
                                    <div id="notificationWorkPermitListContainer" class="vstack gap-2"></div>
                                    <nav id="pagination-workPermit-controls" class="mt-4"></nav>
                                </div>
                                <div class="col-lg-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">ขาดต่อขอรับใหม่ (<span id="workPermitExpiredCount">0</span>)</h5>
                                        <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="workPermitExpired"><i class="bi bi-download"></i></button>
                                    </div>
                                    <div id="notificationWorkPermitExpiredListContainer" class="vstack gap-2"></div>
                                    <nav id="pagination-workPermitExpired-controls" class="mt-4"></nav>
                                </div>
                                <div class="col-lg-4">
                                     <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5 class="mb-0">วีซ่าหมดอายุ (<span id="visaCount">0</span>)</h5>
                                        <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="visa"><i class="bi bi-download"></i></button>
                                    </div>
                                    <div id="notificationVisaListContainer" class="vstack gap-2"></div>
                                    <nav id="pagination-visa-controls" class="mt-4"></nav>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="n-ci-renew" role="tabpanel">
                            <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <input type="text" class="form-control form-control-sm w-auto" id="search-ci_renew-input" placeholder="ค้นหา...">
                                <select class="form-select form-select-sm w-auto" id="search-ci_renew-nationality"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-ci_renew-mou"><option value="">-- ทุกประเภท มติ. --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option>อื่นๆ</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-ci_renew-month">
                                    <option value="">-- ทุกเดือน --</option>
                                    <option value="0">มกราคม</option><option value="1">กุมภาพันธ์</option><option value="2">มีนาคม</option><option value="3">เมษายน</option><option value="4">พฤษภาคม</option><option value="5">มิถุนายน</option><option value="6">กรกฎาคม</option><option value="7">สิงหาคม</option><option value="8">กันยายน</option><option value="9">ตุลาคม</option><option value="10">พฤศจิกายน</option><option value="11">ธันวาคม</option>
                                </select>
                                <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="ci_renew"><i class="bi bi-download me-1"></i> Export</button>
                            </div>
                            <h5 class="mb-3">รายการต่ออายุเล่ม CI (<span id="ci_renewCount">0</span>)</h5>
                            <div id="notificationCi_renewListContainer" class="vstack gap-2"></div>
                            <nav id="pagination-ci_renew-controls" class="mt-4"></nav>
                        </div>
                        <div class="tab-pane fade" id="n-resolution-renew" role="tabpanel">
                            <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <input type="text" class="form-control form-control-sm w-auto" id="search-resolution_renew-input" placeholder="ค้นหา...">
                                <select class="form-select form-select-sm w-auto" id="search-resolution_renew-nationality"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-resolution_renew-mou"><option value="">-- ทุกประเภท มติ. --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option>อื่นๆ</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-resolution_renew-month">
                                    <option value="">-- ทุกเดือน --</option><option value="0">มกราคม</option><option value="1">กุมภาพันธ์</option><option value="2">มีนาคม</option><option value="3">เมษายน</option><option value="4">พฤษภาคม</option><option value="5">มิถุนายน</option><option value="6">กรกฎาคม</option><option value="7">สิงหาคม</option><option value="8">กันยายน</option><option value="9">ตุลาคม</option><option value="10">พฤศจิกายน</option><option value="11">ธันวาคม</option>
                                </select>

                                <select class="form-select form-select-sm w-auto" id="search-resolution_renew-step">
                                    <option value="">-- ทุกขั้นตอน --</option>
                                    <option value="not_started">ยังไม่เริ่ม</option>
                                    <option value="step1">ขั้นตอนที่ 1</option>
                                    <option value="step2">ขั้นตอนที่ 2</option>
                                    <option value="step3">ขั้นตอนที่ 3</option>
                                    <option value="step4">ขั้นตอนที่ 4</option>
                                    <option value="step5">ขั้นตอนที่ 5</option>
                                    <option value="step6">ขั้นตอนที่ 6 (เสร็จสิ้น)</option>
                                </select>
                                <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="resolution_renew"><i class="bi bi-download me-1"></i> Export</button>
                            </div>
                            <h5 class="mb-3">รายการต่ออายุมติในประเทศ (<span id="resolution_renewCount">0</span>)</h5>
                            <div id="notificationResolution_renewListContainer" class="vstack gap-2"></div>
                            <nav id="pagination-resolution_renew-controls" class="mt-4"></nav>
                        </div>
                        <div class="tab-pane fade" id="n-cancelled-renew" role="tabpanel">
                            <div class="d-flex justify-content-end gap-2 mb-3 flex-wrap">
                                <input type="text" class="form-control form-control-sm w-auto" id="search-cancelled_renew-input" placeholder="ค้นหา...">
                                <select class="form-select form-select-sm w-auto" id="search-cancelled_renew-nationality"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-cancelled_renew-mou"><option value="">-- ทุกประเภท มติ. --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option>อื่นๆ</option></select>
                                <select class="form-select form-select-sm w-auto" id="search-cancelled_renew-month">
                                    <option value="">-- ทุกเดือน --</option>
                                    <option value="0">มกราคม</option><option value="1">กุมภาพันธ์</option><option value="2">มีนาคม</option><option value="3">เมษายน</option><option value="4">พฤษภาคม</option><option value="5">มิถุนายน</option><option value="6">กรกฎาคม</option><option value="7">สิงหาคม</option><option value="8">กันยายน</option><option value="9">ตุลาคม</option><option value="10">พฤศจิกายน</option><option value="11">ธันวาคม</option>
                                </select>
                                <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="cancelled_renew"><i class="bi bi-download me-1"></i> Export</button>
                            </div> 
                            <h5 class="mb-3">รายการที่ยกเลิกการต่ออายุ (<span id="cancelled_renewCount">0</span>)</h5>
                            <div id="notificationCancelled_renewListContainer" class="vstack gap-2"></div>
                            <nav id="pagination-cancelled_renew-controls" class="mt-4"></nav>
                        </div>
                    </div>
                </div>
            </div>

            <div id="employer-system-pane" class="content-pane active">
                <div class="p-4 p-md-5 content-section">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                         <h2 class="mb-3 mb-md-0">รายการข้อมูลนายจ้าง <span id="employerTotalCount" class="badge bg-primary align-middle"></span></h2>
                         <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm w-auto" placeholder="ค้นหา..." id="searchEmployerInput">
                            <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="employers"><i class="bi bi-download me-1"></i> Export</button>
                            <button type="button" class="btn btn-primary btn-sm" id="addNewEmployerButton"><i class="bi bi-plus-circle me-1"></i> เพิ่มข้อมูลใหม่</button>
                         </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>#</th><th>ชื่อนายจ้าง (ไทย)</th><th>รหัสนายจ้าง</th><th>ประเภทกิจการ</th><th>เจ้าของงาน</th><th class="text-center">จัดการ</th></tr></thead>
                            <tbody id="employerRecordsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="importer-system-pane" class="content-pane" style="display: none;">
                <div class="p-4 p-md-5 content-section">
                     <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                         <h2 class="mb-3 mb-md-0">รายการข้อมูลบริษัทนำเข้า</h2>
                         <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm w-auto" placeholder="ค้นหา..." id="searchImporterInput">
                             <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="importers"><i class="bi bi-download me-1"></i> Export</button>
                            <button type="button" class="btn btn-primary btn-sm" id="addNewImporterButton"><i class="bi bi-plus-circle me-1"></i> เพิ่มข้อมูลใหม่</button>
                         </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>#</th><th>ชื่อบริษัท (ไทย)</th><th>เลขประจำตัว</th><th>ผู้ลงนาม (ไทย)</th><th class="text-center">จัดการ</th></tr></thead>
                            <tbody id="importerRecordsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="agent-system-pane" class="content-pane" style="display: none;">
                <div class="p-4 p-md-5 content-section">
                     <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                         <h2 class="mb-3 mb-md-0">รายการข้อมูลเอเจนซี่</h2>
                         <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm w-auto" placeholder="ค้นหา..." id="searchAgentInput">
                             <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="agents"><i class="bi bi-download me-1"></i> Export</button>
                            <button type="button" class="btn btn-primary btn-sm" id="addNewAgentButton"><i class="bi bi-plus-circle me-1"></i> เพิ่มข้อมูลใหม่</button>
                         </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>#</th><th>ชื่อเอเจนซี่</th><th>License</th><th>เบอร์โทรศัพท์</th><th class="text-center">จัดการ</th></tr></thead>
                            <tbody id="agentRecordsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="delegate-system-pane" class="content-pane" style="display: none;">
                <div class="p-4 p-md-5 content-section">
                     <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4">
                         <h2 class="mb-3 mb-md-0">รายการข้อมูลพนักงานบริษท</h2>
                         <div class="d-flex gap-2">
                            <input type="text" class="form-control form-control-sm w-auto" placeholder="ค้นหา..." id="searchDelegateInput">
                            <button type="button" class="btn btn-outline-success btn-sm export-btn" data-export-type="delegates"><i class="bi bi-download me-1"></i> Export</button>
                            <button type="button" class="btn btn-primary btn-sm" id="addNewDelegateButton"><i class="bi bi-plus-circle me-1"></i> เพิ่มข้อมูลใหม่</button>
                         </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>#</th><th>รูป</th><th>ชื่อ (ไทย)</th><th>เลขประจำตัวประชาชน</th><th>เบอร์โทรศัพท์</th><th class="text-center">จัดการ</th></tr></thead>
                            <tbody id="delegateRecordsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            

    <div class="modal fade" id="employerInfoModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="employerInfoModalLabel">ฟอร์มข้อมูลนายจ้าง</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="employerForm"><h5>ข้อมูลนายจ้าง</h5><hr><input type="hidden" id="employerRecordIndex" value="-1"><div class="row mb-3"><div class="col-md-6"><label for="employerNameTh" class="form-label">ชื่อนายจ้าง (ไทย)</label><input type="text" class="form-control" id="employerNameTh"></div><div class="col-md-6"><label for="employerNameEn" class="form-label">ชื่อนายจ้าง (อังกฤษ)</label><input type="text" class="form-control" id="employerNameEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="employerId" class="form-label">รหัสนายจ้าง</label><input type="text" class="form-control" id="employerId" readonly required></div><div class="col-md-6"><label for="employerTaxId" class="form-label">เลขประจำตัวนายจ้าง</label><input type="text" class="form-control" id="employerTaxId"></div></div><div class="row mb-3"><div class="col-md-6"><label for="jobOwnerId" class="form-label">เจ้าของงาน</label><div class="input-group"><select class="form-select" id="jobOwnerId"><option value="">-- เลือกเจ้าของงาน --</option></select><button class="btn btn-outline-secondary" type="button" id="addNewJobOwnerBtn" title="เพิ่มเจ้าของงานใหม่"><i class="bi bi-plus"></i></button><button class="btn btn-outline-danger" type="button" id="deleteJobOwnerBtn" title="ลบเจ้าของงานที่เลือก" disabled><i class="bi bi-trash"></i></button></div></div></div><div class="row mb-3"><div class="col-md-6"><label for="signerNameTh" class="form-label">ผู้มีอำนาจลงนาม (ไทย)</label><input type="text" class="form-control" id="signerNameTh"></div><div class="col-md-6"><label for="signerNameEn" class="form-label">ผู้มีอำนาจลงนาม (อังกฤษ)</label><input type="text" class="form-control" id="signerNameEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="businessType" class="form-label">ประเภทกิจการ</label><input type="text" class="form-control" id="businessType"></div><div class="col-md-6"><label for="businessTypeEn" class="form-label">Type of Business</label><input type="text" class="form-control" id="businessTypeEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="regCapital" class="form-label">ทุนจดทะเบียน</label><input type="text" class="form-control" id="regCapital"></div><div class="col-md-6"><label for="regDate" class="form-label">จดทะเบียนวันที่</label><input type="date" class="form-control" id="regDate"></div></div><hr>
<h5>เอกสารแนบของนายจ้าง</h5>
<div class="row">
    <div class="col-md-6">
        <label for="employerDocumentFile" class="form-label">ไฟล์เอกสารนายจ้าง</label>
        <input type="file" class="form-control form-control-sm" id="employerDocumentFile">
        <div id="employerDocumentFileDisplay" class="file-upload-display mt-1"></div>
    </div>
</div><hr class="my-4"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">ที่อยู่ตามทะเบียน</h5><button type="button" class="btn btn-sm btn-outline-success add-address-btn" data-type="registered"><i class="bi bi-plus-lg"></i> เพิ่มที่อยู่</button></div><div id="registeredAddressList" class="vstack gap-3"></div><hr class="my-4"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">ที่อยู่สถานที่ทำงาน</h5><button type="button" class="btn btn-sm btn-outline-success add-address-btn" data-type="workplace"><i class="bi bi-plus-lg"></i> เพิ่มที่อยู่</button></div><div id="workplaceAddressList" class="vstack gap-3"></div><hr class="my-4"><div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2"><h5>ข้อมูลพนักงาน <span id="employeeTotalCount" class="badge bg-secondary fw-normal"></span></h5><div class="d-flex gap-2 flex-wrap"><input type="text" class="form-control form-control-sm" id="searchEmployeeInput" placeholder="ค้นหาพนักงาน..." style="width: 150px;"><select class="form-select form-select-sm" id="searchEmployeeNationality" style="width: 150px;"><option value="">-- ทุกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select><select class="form-select form-select-sm" id="searchEmployeeMOUGroup" style="width: 200px;">
    <option value="">-- ทุกประเภท มติ. --</option>
    <option>MOU</option>
    <option>มติต่ออายุในประเทศ</option>
    <option>มติขึ้นทะเบียน</option>
    <option>อื่นๆ</option>
</select>
<select class="form-select form-select-sm" id="searchEmployeePinkCard" style="width: 150px;">
    <option value="">-- บัตรชมพู --</option>
    <option value="has_card">มีบัตรชมพู</option>
    <option value="no_card">ไม่มีบัตรชมพู</option>
</select>
    </option></select><button type="button" class="btn btn-sm btn-outline-success export-btn" data-export-type="employees"><i class="bi bi-download"></i> ส่งออก</button><button type="button" class="btn btn-sm btn-outline-success add-employee-btn"><i class="bi bi-person-plus"></i> เพิ่มพนักงาน</button></div></div><div id="employeeList" class="vstack gap-3"></div><hr class="my-4"><div class="d-flex justify-content-between align-items-center mb-3 gap-2"><h5>ประวัติการจ้างงาน</h5><div class="d-flex gap-2"><input type="text" class="form-control form-control-sm" id="searchHistoryInput" placeholder="ค้นหาในประวัติ..." style="width: 200px;"><button type="button" class="btn btn-sm btn-outline-success export-btn" data-export-type="employmentHistory"><i class="bi bi-download"></i> ส่งออก</button></div></div><div id="employmentHistoryList" class="vstack gap-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary cancel-form-btn">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveEmployerButton"><i class="bi bi-save"></i> บันทึกข้อมูล</button></div></div></div></div>
    <div class="modal fade" id="importerInfoModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="importerInfoModalLabel">ฟอร์มข้อมูลบริษัทนำเข้า</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="importerForm"><h5>ข้อมูลบริษัทนำเข้า</h5><hr><input type="hidden" id="importerRecordIndex" value="-1"><div class="row mb-3"><div class="col-md-6"><label for="importerNameTh" class="form-label">ชื่อ บนจ. (ไทย)</label><input type="text" class="form-control" id="importerNameTh"></div><div class="col-md-6"><label for="importerNameEn" class="form-label">ชื่อ บนจ. (อังกฤษ)</label><input type="text" class="form-control" id="importerNameEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="importerId" class="form-label">เลขประจำตัว</label><input type="text" class="form-control" id="importerId"></div></div><div class="row mb-3"><div class="col-md-4"><label for="importerLicenseNo" class="form-label">เลขที่ใบอนุญาต</label><input type="text" class="form-control" id="importerLicenseNo"></div><div class="col-md-4"><label for="importerLicenseIssueDate" class="form-label">วันที่ออกใบอนุญาต</label><input type="date" class="form-control" id="importerLicenseIssueDate"></div><div class="col-md-4"><label for="importerLicenseExpiryDate" class="form-label">วันสิ้นสุดใบอนุญาต</label><input type="date" class="form-control" id="importerLicenseExpiryDate"></div></div><div class="row mb-3"><div class="col-md-6"><label for="importerSignerTh" class="form-label">คนเซ็น (ไทย)</label><input type="text" class="form-control" id="importerSignerTh"></div><div class="col-md-6"><label for="importerSignerEn" class="form-label">คนเซ็น (อังกฤษ)</label><input type="text" class="form-control" id="importerSignerEn"></div></div><hr class="my-4"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">ที่อยู่บริษัทนำเข้า</h5><button type="button" class="btn btn-sm btn-outline-success add-address-btn" data-type="importer"><i class="bi bi-plus-lg"></i> เพิ่มที่อยู่</button></div><div id="importerAddressList" class="vstack gap-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary cancel-form-btn">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveImporterButton"><i class="bi bi-save"></i> บันทึกข้อมูล</button></div></div></div></div>
    <div class="modal fade" id="agentInfoModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="agentInfoModalLabel">ฟอร์มข้อมูลเอเจนซี่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="agentForm"><input type="hidden" id="agentRecordIndex" value="-1"><div class="row mb-3"><div class="col-md-12"><label for="agentNameEn" class="form-label">ชื่อเอเจนซี่ (Agent Name)</label><input type="text" class="form-control" id="agentNameEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="agentLicense" class="form-label">License</label><input type="text" class="form-control" id="agentLicense"></div></div><div class="row mb-3"><div class="col-md-6"><label for="agentPhone" class="form-label">เบอร์โทรศัพท์</label><input type="tel" class="form-control" id="agentPhone"></div><div class="col-md-6"><label for="agentEmail" class="form-label">อีเมล</label><input type="email" class="form-control" id="agentEmail"></div></div><div class="mb-3"><label for="agentAddress" class="form-label">ที่อยู่</label><textarea class="form-control" id="agentAddress" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary cancel-form-btn">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveAgentButton"><i class="bi bi-save"></i> บันทึกข้อมูล</button></div></div></div></div>
    <div class="modal fade" id="delegateInfoModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="delegateInfoModalLabel">ฟอร์มข้อมูลพนักงาน</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="delegateForm"><input type="hidden" id="delegateRecordIndex" value="-1"><h5>ข้อมูลพนักงาน</h5><hr><div class="row"><div class="col-md-8"><div class="row mb-3"><div class="col-md-6"><label for="delegateNameTh" class="form-label">ชื่อ (ไทย)</label><input type="text" class="form-control" id="delegateNameTh"></div><div class="col-md-6"><label for="delegateNameEn" class="form-label">ชื่อ (อังกฤษ)</label><input type="text" class="form-control" id="delegateNameEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="delegateId" class="form-label">เลขประจำตัวประชาชน</label><input type="text" class="form-control" id="delegateId"></div><div class="col-md-6"><label for="delegateEmployeeId" class="form-label">รหัสพนักงาน</label><input type="text" class="form-control" id="delegateEmployeeId"></div></div><div class="row mb-3"><div class="col-md-6"><label for="delegateIssueDate" class="form-label">วันที่ออกบัตร</label><input type="date" class="form-control" id="delegateIssueDate"></div><div class="col-md-6"><label for="delegateExpiryDate" class="form-label">วันสิ้นสุดบัตร</label><input type="date" class="form-control" id="delegateExpiryDate"></div></div><div class="row mb-3"><div class="col-md-6"><label for="delegatePhone" class="form-label">เบอร์โทรศัพท์</label><input type="tel" class="form-control" id="delegatePhone"></div><div class="col-md-6"><label for="delegateEmail" class="form-label">อีเมล</label><input type="email" class="form-control" id="delegateEmail"></div></div></div><div class="col-md-4 text-center"><img id="delegatePhotoPreview" src="https://placehold.co/120x120/f8fafc/6c757d?text=Photo" class="employee-photo-preview mb-2"><input type="file" class="form-control form-control-sm" id="delegatePhoto" accept="image/*"></div></div><hr class="my-4"><div class="d-flex justify-content-between align-items-center mb-3"><h5 class="mb-0">ที่อยู่</h5><button type="button" class="btn btn-sm btn-outline-success add-address-btn" data-type="delegate"><i class="bi bi-plus-lg"></i> เพิ่มที่อยู่</button></div><div id="delegateAddressList" class="vstack gap-3"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary cancel-form-btn">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveDelegateButton"><i class="bi bi-save"></i> บันทึกข้อมูล</button></div></div></div></div>
    <div class="modal fade" id="addressModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="addressModalLabel">เพิ่ม/แก้ไขที่อยู่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addressForm"><input type="hidden" id="addressType"><input type="hidden" id="addressIndex" value="-1"><div class="row mb-3"><div class="col-md-3"><label for="addrNo" class="form-label">เลขที่</label><input type="text" class="form-control" id="addrNo"></div><div class="col-md-3"><label for="addrMoo" class="form-label">หมู่</label><input type="text" class="form-control" id="addrMoo"></div></div><div class="row mb-3"><div class="col-md-6"><label for="addrSoi" class="form-label">ซอย</label><input type="text" class="form-control" id="addrSoi"></div><div class="col-md-6"><label for="addrSoiEn" class="form-label">Soi (English)</label><input type="text" class="form-control" id="addrSoiEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="addrRoad" class="form-label">ถนน</label><input type="text" class="form-control" id="addrRoad"></div><div class="col-md-6"><label for="addrRoadEn" class="form-label">Road (English)</label><input type="text" class="form-control" id="addrRoadEn"></div></div><div class="row mb-3"><div class="col-md-6"><label for="addrProvince" class="form-label">จังหวัด</label><select class="form-select" id="addrProvince"></select></div><div class="col-md-6"><label for="addrProvinceEn" class="form-label">Province</label><input type="text" class="form-control" id="addrProvinceEn" readonly></div></div><div class="row mb-3"><div class="col-md-6"><label for="addrDistrict" class="form-label">เขต/อำเภอ</label><select class="form-select" id="addrDistrict" disabled></select></div><div class="col-md-6"><label for="addrDistrictEn" class="form-label">District</label><input type="text" class="form-control" id="addrDistrictEn" readonly></div></div><div class="row mb-3"><div class="col-md-6"><label for="addrSubDistrict" class="form-label">แขวง/ตำบล</label><select class="form-select" id="addrSubDistrict" disabled></select></div><div class="col-md-6"><label for="addrSubDistrictEn" class="form-label">Sub-district</label><input type="text" class="form-control" id="addrSubDistrictEn" readonly></div></div><div class="row mb-3"><div class="col-md-6"><label for="addrZipCode" class="form-label">รหัสไปรษณีย์</label><input type="text" class="form-control" id="addrZipCode" readonly></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary cancel-form-btn">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveAddressButton">บันทึกที่อยู่</button></div></div></div></div>
    <div class="modal fade" id="employeeInfoModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="employeeInfoModalLabel">เพิ่ม/แก้ไขข้อมูลพนักงาน</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="employeeForm"><input type="hidden" id="employeeIndex" value="-1"><input type="hidden" id="parentEmployerIndex"><h5>ข้อมูลส่วนตัว</h5><hr><div class="row"><div class="col-md-8"><div class="row mb-3"><div class="col-md-6"><label for="employeeNameTh" class="form-label">ชื่อพนักงาน (ไทย)</label><div class="input-group"><select class="form-select" id="employeeTitleTh" style="max-width: 100px;"><option value="นาย">นาย</option><option value="นางสาว">นางสาว</option><option value="นาง">นาง</option></select><input type="text" class="form-control" id="employeeNameTh"></div></div><div class="col-md-6"><label for="employeeNameEn" class="form-label">ชื่อพนักงาน (อังกฤษ)</label><div class="input-group"><select class="form-select" id="employeeTitleEn" style="max-width: 100px;"><option value="Mr.">Mr.</option><option value="Miss">Miss</option><option value="Mrs.">Mrs.</option></select><input type="text" class="form-control" id="employeeNameEn"></div></div></div><div class="row mb-3"><div class="col-md-6"><label for="employeeDob" class="form-label">วันเดือนปีเกิด</label><input type="date" class="form-control" id="employeeDob"></div><div class="col-md-6"><label for="employeeAge" class="form-label">อายุ</label><input type="text" class="form-control" id="employeeAge" readonly></div></div><div class="row mb-3"><div class="col-md-6"><label for="employeeNationality" class="form-label">สัญชาติ</label><select class="form-select" id="employeeNationality"><option value="">-- เลือกสัญชาติ --</option><option>ลาว</option><option>กัมพูชา</option><option>เมียนมา</option><option>เวียดนาม</option></select></div><div class="col-md-6"><label for="employeePassport" class="form-label">เลขหนังสือเดินทาง (Passport No.)</label><input type="text" class="form-control" id="employeePassport"></div></div><div class="row mb-3 d-none" id="passportTypeRow"><div class="col-md-6"><label for="passportType" class="form-label">ประเภทหนังสือเดินทาง</label><select class="form-select" id="passportType"><option value="">-- เลือกประเภท --</option><option value="PJ">เล่ม PJ</option><option value="CI">เล่ม CI</option></select></div></div></div><div class="col-md-4 text-center"><img id="employeePhotoPreview" src="https://placehold.co/120x120/f8fafc/6c757d?text=Photo" class="employee-photo-preview mb-2"><input type="file" class="form-control form-control-sm" id="employeePhoto" accept="image/*"></div></div><hr><h5>ข้อมูลการจ้างงานและเอกสารราชการ</h5><hr><div class="row mb-3"><div class="col-md-4"><label for="namelistNo" class="form-label">เลขที่ Namelist</label><input type="text" class="form-control" id="namelistNo"></div><div class="col-md-4"><label for="requestNo" class="form-label">เลขที่คำขอ</label><input type="text" class="form-control" id="requestNo"></div><div class="col-md-4"><label for="workerRefNo" class="form-label">เลขอ้างอิงคนงาน</label><input type="text" class="form-control" id="workerRefNo"></div></div><div class="row mb-3"><div class="col-md-4"><label for="personalId" class="form-label">เลขประจำตัว</label><input type="text" class="form-control" id="personalId"></div><div class="col-md-4"><label for="companyWorkerId" class="form-label">รหัสคนงาน (บริษัท)</label><input type="text" class="form-control" id="companyWorkerId"></div><div class="col-md-4"><label for="pinkCardNo" class="form-label">เลขบัตรชมพู</label><input type="text" class="form-control" id="pinkCardNo"></div></div><div class="row mb-3"><div class="col-md-4"><label for="socialSecurityNo" class="form-label">เลขประกันสังคม</label><input type="text" class="form-control" id="socialSecurityNo"></div><div class="col-md-4"><label for="taxIdNo" class="form-label">เลขประจำตัวผู้เสียภาษี</label><input type="text" class="form-control" id="taxIdNo"></div><div class="col-md-4"><label for="designatedHospital" class="form-label">โรงพยาบาลตามสิทธิ</label><input type="text" class="form-control" id="designatedHospital"></div></div><hr><div class="row mb-3"><div class="col-md-6"><label for="passportExpiryDate" class="form-label">วันหมดอายุหนังสือเดินทาง</label><input type="date" class="form-control" id="passportExpiryDate"></div><div class="col-md-6"><label for="workPermitExpiryDate" class="form-label">วันหมดอายุใบอนุญาตทำงาน</label><input type="date" class="form-control" id="workPermitExpiryDate"></div></div><div class="row mb-3"><div class="col-md-6"><label for="workPermitMOUGroup" class="form-label">ประเภทใบอนุญาตทำงาน(กลุ่ม มติ.)</label><select class="form-select" id="workPermitMOUGroup"><option value="">-- กรุณาเลือก --</option><option>MOU</option><option>มติต่ออายุในประเทศ</option><option>มติขึ้นทะเบียน</option><option value="อื่นๆ">อื่นๆ ระบุ..</option></select><input type="text" class="form-control mt-2 d-none" id="workPermitMOUGroupOther" placeholder="ระบุประเภทใบอนุญาตทำงาน"></div><div class="col-md-6"><label for="visaExpiryDate" class="form-label">วันหมดอายุวีซ่า</label><input type="date" class="form-control" id="visaExpiryDate"></div></div><div class="row mb-3"><div class="col-md-6"><label for="employeeWorkPermit" class="form-label">ใบอนุญาตทำงาน (Work Permit No.)</label><input type="text" class="form-control" id="employeeWorkPermit"></div><div class="col-md-6"><label for="ninetyDayReportDate" class="form-label">วันหมดอายุรายงานตัว 90 วัน</label><input type="date" class="form-control" id="ninetyDayReportDate"></div></div><div class="row mb-3"><div class="col-md-6"><label for="startDate" class="form-label">วันเริ่มงาน</label><input type="date" class="form-control" id="startDate"></div><div class="col-md-6"><label for="employeePhone" class="form-label">เบอร์โทรศัพท์</label><input type="tel" class="form-control" id="employeePhone"></div></div><div class="row mb-3"><div class="col-md-6"><label for="employeePosition" class="form-label">ตำแหน่ง</label><input type="text" class="form-control" id="employeePosition"></div></div><hr><h5>เอกสารแนบ</h5><div class="row"><div class="col-md-4"><label for="employeePassportFile" class="form-label">ไฟล์ Passport</label><input type="file" class="form-control form-control-sm" id="employeePassportFile"><div id="employeePassportFileDisplay" class="file-upload-display mt-1"></div></div><div class="col-md-4"><label for="employeeWorkPermitFile" class="form-label">ไฟล์ใบอนุญาตทำงาน</label><input type="file" class="form-control form-control-sm" id="employeeWorkPermitFile"><div id="employeeWorkPermitFileDisplay" class="file-upload-display mt-1"></div></div><div class="col-md-4"><label for="pinkCardFile" class="form-label">ไฟล์บัตรชมพู</label><input type="file" class="form-control form-control-sm" id="pinkCardFile"><div id="pinkCardFileDisplay" class="file-upload-display mt-1"></div></div></div><div class="row mt-3 d-none" id="myanmarDocsRow"><div class="col-md-6"><label for="myanmarIdFile" class="form-label">ไฟล์บัตรประชาชน/ทะเบียนบ้านเมียนมา</label><input type="file" class="form-control form-control-sm" id="myanmarIdFile"><div id="myanmarIdFileDisplay" class="file-upload-display mt-1"></div></div><div class="col-md-6"><label for="myanmarHouseRegFile" class="form-label">ไฟล์ อื่นๆ</label><input type="file" class="form-control form-control-sm" id="myanmarHouseRegFile"><div id="myanmarHouseRegFileDisplay" class="file-upload-display mt-1"></div></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary cancel-form-btn">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveEmployeeButton">บันทึกข้อมูลพนักงาน</button></div></div></div></div>
    
    <div class="modal fade" id="jobOwnerModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">เพิ่มเจ้าของงานใหม่</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="jobOwnerForm"><div class="mb-3"><label for="jobOwnerName" class="form-label">ชื่อเจ้าของงาน</label><input type="text" class="form-control" id="jobOwnerName" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveJobOwnerButton">บันทึก</button></div></div></div></div>

    <div class="modal fade" id="renewModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="renewModalLabel">ต่ออายุ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="renewForm"><input type="hidden" id="renewEmployerIndex"><input type="hidden" id="renewEmployeeIndex"><input type="hidden" id="renewType"><div class="mb-3"><label for="renewDate" class="form-label">วันหมดอายุใหม่</label><input type="date" class="form-control" id="renewDate"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" id="saveRenewalButton">บันทึก</button></div></div></div></div>
    
    <div class="modal fade" id="taskTrackingModal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ติดตามขั้นตอนการต่ออายุมติ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="taskTrackingForm"><input type="hidden" id="taskTrackingEmployerIndex"><input type="hidden" id="taskTrackingEmployeeIndex"><h6>ข้อมูลอ้างอิง</h6><div class="row mb-3"><div class="col-md-4"><label for="taskNamelistNo" class="form-label">เลขที่ Namelist</label><input type="text" class="form-control" id="taskNamelistNo"></div><div class="col-md-4"><label for="taskRequestNo" class="form-label">เลขที่คำขอ</label><input type="text" class="form-control" id="taskRequestNo"></div><div class="col-md-4"><label for="taskWorkerRefNo" class="form-label">เลขอ้างอิงคนงาน</label><input type="text" class="form-control" id="taskWorkerRefNo"></div></div><hr><h6>ขั้นตอนการดำเนินงาน</h6><div class="vstack gap-3" id="taskTrackingStepsContainer"><div class="step-item" id="step1-item"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="step1_checked" data-step="1"><label class="form-check-label" for="step1_checked">ขั้นตอนที่ 1: ยื่นคำขอ</label></div><input type="date" class="form-control form-control-sm ms-auto" id="step1_date" style="max-width: 150px;" readonly></div><div class="step-item" id="step2-item"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="step2_checked" data-step="2"><label class="form-check-label" for="step2_checked">ขั้นตอนที่ 2: อนุมัติคำขอ</label></div><input type="date" class="form-control form-control-sm ms-auto" id="step2_date" style="max-width: 150px;" readonly></div><div class="step-item" id="step3-item"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="step3_checked" data-step="3"><label class="form-check-label" for="step3_checked">ขั้นตอนที่ 3: ใบแพทย์</label></div><input type="date" class="form-control form-control-sm ms-auto" id="step3_date" style="max-width: 150px;" readonly></div><div class="step-item" id="step4-item"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="step4_checked" data-step="4"><label class="form-check-label" for="step4_checked">ขั้นตอนที่ 4: </label></div><select class="form-select form-select-sm" id="step4_choice" style="max-width: 150px;"><option>ซื้อประกัน</option><option>ประกันสังคม</option></select><input type="date" class="form-control form-control-sm ms-auto" id="step4_date" style="max-width: 150px;" readonly></div><div class="step-item" id="step5-item"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="step5_checked" data-step="5"><label class="form-check-label" for="step5_checked">ขั้นตอนที่ 5: ยื่นชำระเงิน</label></div><input type="date" class="form-control form-control-sm ms-auto" id="step5_date" style="max-width: 150px;" readonly></div><div class="step-item" id="step6-item"><div class="form-check"><input class="form-check-input" type="checkbox" value="" id="step6_checked" data-step="6"><label class="form-check-label" for="step6_checked">ขั้นตอนที่ 6: อนุมัติ</label></div><input type="date" class="form-control form-control-sm ms-auto" id="step6_date" style="max-width: 150px;" readonly></div></div></form></div><div class="modal-footer justify-content-between"><button type="button" class="btn btn-primary" id="saveTaskTrackingButton"><i class="bi bi-floppy"></i> บันทึกขั้นตอน</button><button type="button" class="btn btn-success" id="triggerRenewButton" disabled><i class="bi bi-calendar-check"></i> ต่ออายุ</button></div></div></div></div>

    <div class="modal fade" id="terminateEmployeeModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">แจ้งออก / เลิกจ้าง</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="terminateEmployeeForm"><input type="hidden" id="terminateEmployeeIndex"><div class="mb-3"><label for="terminateDate" class="form-label">วันที่แจ้งออก / เลิกจ้าง</label><input type="date" class="form-control" id="terminateDate" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-primary" id="confirmTerminateEmployeeButton">ยืนยัน</button></div></div></div></div>


    <div class="modal fade" id="confirmCancelModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ยืนยันการยกเลิก</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>คุณแน่ใจหรือไม่ว่าต้องการยกเลิก? การเปลี่ยนแปลงที่ยังไม่ได้บันทึกจะสูญหายไป</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">อยู่ต่อ</button><button type="button" class="btn btn-danger" id="confirmCancelButton">ยืนยันการยกเลิก</button></div></div></div></div>
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmDeleteModalLabel">ยืนยันการลบ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmDeleteModalBody"><p>คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-danger" id="confirmDeleteButton">ยืนยัน</button></div></div></div></div>
    <div class="modal fade" id="confirmRestoreModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmRestoreModalLabel">ยืนยันการกู้คืน</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="confirmRestoreModalBody"><p>คุณแน่ใจหรือไม่ว่าต้องการกู้คืนข้อมูลพนักงานคนนี้?</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-success" id="confirmRestoreButton">ยืนยัน</button></div></div></div></div>
    <div class="modal fade" id="confirmCancelRenewalModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ยืนยันการยกเลิกต่ออายุ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>คุณแน่ใจหรือไม่ว่าต้องการยกเลิกการต่ออายุสำหรับพนักงานคนนี้? คุณสามารถนำกลับมาทำใหม่ได้จากแท็บ "รายการที่ยกเลิก"</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ไม่</button><button type="button" class="btn btn-warning" id="confirmCancelRenewalButton">ใช่, ยกเลิก</button></div></div></div></div>
    <div class="modal fade" id="confirmRestoreRenewalModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">ยืนยันการนำกลับ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>คุณแน่ใจหรือไม่ว่าต้องการนำรายการนี้กลับเข้าสู่กระบวนการต่ออายุ?</p></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button><button type="button" class="btn btn-success" id="confirmRestoreRenewalButton">ยืนยัน</button></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            let thaiAddressData = [];
            let currentEditingRecord = {};
            let currentRecordType = ''; 
            let recordToProcess = { type: '', index: -1, employeeIndex: null, historyIndex: null, id: null };
            let activeFormModal = null;
            let tempEmployeeFileData = {}; // To hold file data before saving
            let tempDelegatePhotoData = {}; // To hold delegate photo data
            
            // For dashboard charts
            let charts = {
                nationalityChart: null,
                mouChart: null,
                expiryChart: null
            };

            let currentPages = {
                '90day': 1,
                'passport': 1,
                'workPermit': 1,
                'visa': 1,
                'workPermitExpired': 1,
                'ci_renew': 1,
                'resolution_renew': 1,
                'cancelled_renew': 1
            };
            const ITEMS_PER_PAGE = 25;

            const modals = {
                employer: new bootstrap.Modal(document.getElementById('employerInfoModal')),
                importer: new bootstrap.Modal(document.getElementById('importerInfoModal')),
                agent: new bootstrap.Modal(document.getElementById('agentInfoModal')),
                delegate: new bootstrap.Modal(document.getElementById('delegateInfoModal')),
                address: new bootstrap.Modal(document.getElementById('addressModal')),
                employee: new bootstrap.Modal(document.getElementById('employeeInfoModal')),
                jobOwner: new bootstrap.Modal(document.getElementById('jobOwnerModal')),
                renew: new bootstrap.Modal(document.getElementById('renewModal')),
                taskTracking: new bootstrap.Modal(document.getElementById('taskTrackingModal')),
                terminateEmployee: new bootstrap.Modal(document.getElementById('terminateEmployeeModal')),
                confirmDelete: new bootstrap.Modal(document.getElementById('confirmDeleteModal')),
                confirmRestore: new bootstrap.Modal(document.getElementById('confirmRestoreModal')),
                confirmCancel: new bootstrap.Modal(document.getElementById('confirmCancelModal')),
                confirmCancelRenewal: new bootstrap.Modal(document.getElementById('confirmCancelRenewalModal')),
                confirmRestoreRenewal: new bootstrap.Modal(document.getElementById('confirmRestoreRenewalModal'))
            };
            
            const storageKeys = {
                employers: 'employerRecords',
                importers: 'importerRecords',
                agents: 'agentRecords',
                delegates: 'delegateRecords',
                jobOwners: 'jobOwnerRecords'
            };
            const apiEndpoint = 'https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province_with_amphure_tambon.json';
            const flagMap = {
                'ลาว': 'https://flagcdn.com/w20/la.png',
                'กัมพูชา': 'https://flagcdn.com/w20/kh.png',
                'เมียนมา': 'https://flagcdn.com/w20/mm.png',
                'เวียดนาม': 'https://flagcdn.com/w20/vn.png'
            };
            const nativeLangMap = {
                'ลาว': 'ลาว',
                'กัมพูชา': 'กัมพูชา',
                'เมียนมา': 'เมียนมา',
                'เวียดนาม': 'เวียดนาม'
            };

            const getRecords = (key) => JSON.parse(localStorage.getItem(key) || '[]');
            const saveRecords = (key, records) => {
                try {
                    localStorage.setItem(key, JSON.stringify(records));
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                    alert("เกิดข้อผิดพลาด: ไม่สามารถบันทึกข้อมูลได้ อาจเนื่องมาจากข้อมูลมีขนาดใหญ่เกินไป");
                }
                updateNotificationBadges();
            };
            
            function showSuccessMessage(message) {
                const el = document.getElementById('pageSuccessMessage');
                el.textContent = message;
                el.classList.remove('d-none');
                setTimeout(() => el.classList.add('d-none'), 3000);
            }

            // --- Function to generate next ID ---
            function generateNextId(key, prefix, padLength = 4) {
                const records = getRecords(key);
                let maxNum = 0;
                const idField = key === storageKeys.employers ? 'employerId' : 'id';

                records.forEach(record => {
                    if (record[idField] && record[idField].startsWith(prefix)) {
                        const numPart = parseInt(record[idField].substring(prefix.length), 10);
                        if (!isNaN(numPart) && numPart > maxNum) {
                            maxNum = numPart;
                        }
                    }
                });
                return prefix + String(maxNum + 1).padStart(padLength, '0');
            }

            function formatDateDisplay(dateInput) {
                if (!dateInput) return '-';
                const date = (typeof dateInput === 'string') ? new Date(dateInput) : dateInput;
                if (isNaN(date.getTime())) {
                    return '-';
                }
                const day = date.getDate();
                const year = date.getFullYear();
                const thaiMonth = date.toLocaleDateString('th-TH', { month: 'long' });
                return `${day} ${thaiMonth} ${year}`;
            }

            function getTodayDateString() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            function calculateAge(dobString) {
                if (!dobString) return '';
                const dob = new Date(dobString);
                if (isNaN(dob.getTime())) return '';
                
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                return age >= 0 ? `${age} ปี` : '';
            }

            async function loadAddressData() {
                try {
                    const response = await fetch(apiEndpoint);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    thaiAddressData = await response.json();
                    const provinceEl = document.getElementById('addrProvince');
                    provinceEl.innerHTML = '<option selected disabled value="">-- เลือกจังหวัด --</option>';
                    thaiAddressData.forEach(province => provinceEl.add(new Option(province.name_th, province.name_th)));
                } catch (error) {
                    console.error("Could not load address data from API:", error);
                    document.getElementById('addrProvince').innerHTML = '<option selected disabled value="">-- โหลดข้อมูลล้มเหลว --</option>';
                }
            }
            
            function populateDropdown(dropdown, items, prompt, valueKey = 'name_th') {
                const currentVal = dropdown.value;
                dropdown.innerHTML = `<option selected disabled value="">-- ${prompt} --</option>`;
                items.forEach(item => dropdown.add(new Option(item[valueKey], item[valueKey])));
                dropdown.value = currentVal;
                dropdown.disabled = items.length === 0;
            }

            function openAddressModal(type, index) {
                document.getElementById('addressForm').reset();
                document.getElementById('addressType').value = type;
                document.getElementById('addressIndex').value = index;
                
                if (index > -1) {
                    const address = currentEditingRecord[`${type}Addresses`][index];
                    Object.keys(address).forEach(key => {
                        const el = document.getElementById(key);
                        if (el) el.value = address[key];
                    });
                    const provinceEl = document.getElementById('addrProvince');
                    provinceEl.value = address.addrProvince;
                    provinceEl.dispatchEvent(new Event('change'));
                    
                    setTimeout(() => {
                        const districtEl = document.getElementById('addrDistrict');
                        districtEl.value = address.addrDistrict;
                        districtEl.dispatchEvent(new Event('change'));
                        setTimeout(() => {
                             document.getElementById('addrSubDistrict').value = address.addrSubDistrict;
                        }, 50);
                    }, 50);
                }
                modals.address.show();
            }

            function handleSaveAddress() {
                const type = document.getElementById('addressType').value;
                const index = parseInt(document.getElementById('addressIndex').value, 10);
                const addressData = {};
                const formElements = document.getElementById('addressForm').querySelectorAll('input, select');
                formElements.forEach(el => { if (el.id) addressData[el.id] = el.value; });

                if (!currentEditingRecord[`${type}Addresses`]) {
                    currentEditingRecord[`${type}Addresses`] = [];
                }

                if (index === -1) {
                    currentEditingRecord[`${type}Addresses`].push(addressData);
                } else {
                    currentEditingRecord[`${type}Addresses`][index] = addressData;
                }
                renderAddressList(type);
                modals.address.hide();
            }

            function handleDeleteAddress(type, index) {
                if (currentEditingRecord[`${type}Addresses`]) {
                    currentEditingRecord[`${type}Addresses`].splice(index, 1);
                    renderAddressList(type);
                }
            }

            function getFullAddressString(addr) {
                const partsTh = [], partsEn = [];
                if (addr.addrNo) { partsTh.push(`เลขที่ ${addr.addrNo}`); partsEn.push(`No. ${addr.addrNo}`); }
                if (addr.addrMoo) { partsTh.push(`หมู่ ${addr.addrMoo}`); partsEn.push(`Moo ${addr.addrMoo}`); }
                if (addr.addrSoi) { partsTh.push(`ซอย${addr.addrSoi}`); }
                if (addr.addrSoiEn) { partsEn.push(`Soi ${addr.addrSoiEn}`); }
                if (addr.addrRoad) { partsTh.push(`ถนน${addr.addrRoad}`); }
                if (addr.addrRoadEn) { partsEn.push(`${addr.addrRoadEn} Rd.`); }
                if (addr.addrSubDistrict) { partsTh.push(`แขวง/ตำบล ${addr.addrSubDistrict}`); partsEn.push(addr.addrSubDistrictEn); }
                if (addr.addrDistrict) { partsTh.push(`เขต/อำเภอ ${addr.addrDistrict}`); partsEn.push(addr.addrDistrictEn); }
                if (addr.addrProvince) { partsTh.push(addr.addrProvince); partsEn.push(addr.addrProvinceEn); }
                if (addr.addrZipCode) { partsTh.push(addr.addrZipCode); partsEn.push(addr.addrZipCode); }
                return { th: partsTh.join(' '), en: partsEn.join(', ') };
            }

            function renderAddressList(type) {
                const listContainer = document.getElementById(`${type}AddressList`);
                const addresses = currentEditingRecord[`${type}Addresses`] || [];
                listContainer.innerHTML = '';
                if (addresses.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted">ยังไม่มีที่อยู่</p>';
                } else {
                    addresses.forEach((addr, index) => {
                        const fullAddress = getFullAddressString(addr);
                        const card = document.createElement('div');
                        card.className = 'address-card d-flex justify-content-between align-items-start';
                        card.innerHTML = `
                            <div>
                                <p class="mb-0">${fullAddress.th}</p>
                                <p class="mb-0 text-muted small">${fullAddress.en}</p>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary edit-address-btn" data-type="${type}" data-index="${index}"><i class="bi bi-pencil"></i></button>
                                <button type="button" class="btn btn-outline-danger delete-address-btn" data-type="${type}" data-index="${index}"><i class="bi bi-trash"></i></button>
                            </div>
                        `;
                        listContainer.appendChild(card);
                    });
                }
            }

            function openEmployeeModal(index) {
                document.getElementById('employeeForm').reset();
                tempEmployeeFileData = {};
                document.getElementById('parentEmployerIndex').value = document.getElementById('employerRecordIndex').value;
                document.getElementById('employeeIndex').value = index;

                const modalLabel = document.getElementById('employeeInfoModalLabel');

                const saveButton = document.getElementById('saveEmployeeButton');
                const newSaveButton = saveButton.cloneNode(true); 
                saveButton.parentNode.replaceChild(newSaveButton, saveButton);
                newSaveButton.addEventListener('click', () => saveEmployeeData(index));

                // Reset all fields and displays
                document.getElementById('employeePhotoPreview').src = 'https://placehold.co/120x120/f8fafc/6c757d?text=Photo';
                ['employeePassportFileDisplay', 'employeeWorkPermitFileDisplay', 'pinkCardFileDisplay', 'myanmarIdFileDisplay', 'myanmarHouseRegFileDisplay'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });
                ['passportTypeRow', 'myanmarDocsRow'].forEach(id => document.getElementById(id).classList.add('d-none'));

                if (index > -1) {
                    modalLabel.textContent = 'แก้ไขข้อมูลพนักงาน';
                    const employee = currentEditingRecord.employees[index];
                    Object.keys(employee).forEach(key => {
                        const el = document.getElementById(key);
                        if (el && !el.type.startsWith('file')) el.value = employee[key];
                    });
                    
                    document.getElementById('employeeAge').value = calculateAge(employee.employeeDob) || '';
                    
                    const workPermitMOUGroupSelect = document.getElementById('workPermitMOUGroup');
                    const workPermitMOUGroupOtherInput = document.getElementById('workPermitMOUGroupOther');
                    if (employee.workPermitMOUGroup === 'อื่นๆ') {
                        workPermitMOUGroupSelect.value = 'อื่นๆ';
                        workPermitMOUGroupOtherInput.value = employee.workPermitMOUGroupOther || '';
                        workPermitMOUGroupOtherInput.classList.remove('d-none');
                    } else {
                        workPermitMOUGroupSelect.value = employee.workPermitMOUGroup || '';
                        workPermitMOUGroupOtherInput.classList.add('d-none');
                        workPermitMOUGroupOtherInput.value = '';
                    }

                    document.getElementById('employeeNationality').dispatchEvent(new Event('change'));
                    if (employee.passportType) {
                        document.getElementById('passportType').value = employee.passportType;
                    }
                    
                    if (employee.employeePhoto) document.getElementById('employeePhotoPreview').src = employee.employeePhoto.data;
                    const fileFields = ['employeePassportFile', 'employeeWorkPermitFile', 'pinkCardFile', 'myanmarIdFile', 'myanmarHouseRegFile'];
                    fileFields.forEach(field => {
                        if (employee[field]) {
                            document.getElementById(`${field}Display`).innerHTML = `<a href="${employee[field].data}" target="_blank">ดูไฟล์: ${employee[field].name}</a>`;
                        }
                    });

                } else {
                    modalLabel.textContent = 'เพิ่มข้อมูลพนักงาน';
                    document.getElementById('employeeAge').value = '';
                    document.getElementById('workPermitMOUGroupOther').classList.add('d-none');
                }
                modals.employee.show();
            }

           function initializeEmployeeSubData(employee) {
                if (!employee.taskTrackingData) {
                    employee.taskTrackingData = {
                        step1_checked: false, step1_date: '',
                        step2_checked: false, step2_date: '',
                        step3_checked: false, step3_date: '',
                        step4_choice: 'ซื้อประกัน', step4_checked: false, step4_date: '',
                        step5_checked: false, step5_date: '',
                        step6_checked: false, step6_date: ''
                    };
                }
                // เปลี่ยนไปใช้ Object `cancellations` เพื่อรองรับการยกเลิกหลายประเภท
                if (typeof employee.cancellations === 'undefined') {
                    employee.cancellations = {};
                }
                // ย้ายข้อมูลเก่าจาก `isRenewalCancelled` มายังโครงสร้างใหม่
                if (employee.isRenewalCancelled === true) {
                    // ของเดิมมีปุ่มยกเลิกแค่ที่ 'resolution_renew' จึงย้ายมาที่นี่
                    employee.cancellations['resolution_renew'] = true;
                    delete employee.isRenewalCancelled; // ลบ property เก่าทิ้ง
                } else if (typeof employee.isRenewalCancelled !== 'undefined') {
                    delete employee.isRenewalCancelled; // ลบ property เก่าทิ้งหากมีค่าเป็น false หรืออื่นๆ
                }
                return employee;
            }

            function saveEmployeeData(employeeIndex) {
                const parentEmployerIndex = parseInt(document.getElementById('parentEmployerIndex').value, 10);
                
                let employeeData = {};
                const formElements = document.getElementById('employeeForm').querySelectorAll('input, select, textarea');
                formElements.forEach(el => {
                    if (el.id && !el.type.startsWith('file')) {
                        employeeData[el.id] = el.value;
                    }
                });

                Object.assign(employeeData, tempEmployeeFileData);

                const allEmployers = getRecords(storageKeys.employers);
                if (parentEmployerIndex < 0 || !allEmployers[parentEmployerIndex]) {
                    showSuccessMessage('เกิดข้อผิดพลาด: ไม่พบข้อมูลนายจ้างหลัก');
                    return;
                }
                
                const employerToUpdate = allEmployers[parentEmployerIndex];
                
                if (employeeIndex === -1) { // Add new employee
                    if (!employerToUpdate.employees) employerToUpdate.employees = [];
                    employeeData = initializeEmployeeSubData(employeeData);
                    employerToUpdate.employees.push(employeeData);
                } else { // Update existing employee
                    if (!employerToUpdate.employees || !employerToUpdate.employees[employeeIndex]) {
                         showSuccessMessage('เกิดข้อผิดพลาด: ไม่พบข้อมูลพนักงาน');
                         return;
                    }
                    const existingEmployee = employerToUpdate.employees[employeeIndex];
                    const fileFields = ['employeePhoto', 'employeePassportFile', 'employeeWorkPermitFile', 'pinkCardFile', 'myanmarIdFile', 'myanmarHouseRegFile'];
                    fileFields.forEach(field => {
                        if (!employeeData[field]) employeeData[field] = existingEmployee[field];
                    });

                    Object.assign(employerToUpdate.employees[employeeIndex], employeeData);
                }
                
                saveRecords(storageKeys.employers, allEmployers);
                currentEditingRecord.employees = employerToUpdate.employees; 
                renderEmployeeList(); 
                modals.employee.hide();
                showSuccessMessage(employeeIndex === -1 ? 'เพิ่มข้อมูลพนักงานเรียบร้อยแล้ว' : 'อัพเดตข้อมูลพนักงานเรียบร้อยแล้ว');
            }


            function handleDeleteEmployee(index) {
                const parentEmployerIndex = parseInt(document.getElementById('parentEmployerIndex').value, 10);
                const allEmployers = getRecords(storageKeys.employers);

                if (parentEmployerIndex === -1 || !allEmployers[parentEmployerIndex]) {
                    console.error("Parent employer record not found. Cannot delete employee data.");
                    showSuccessMessage('เกิดข้อผิดพลาด: ไม่พบข้อมูลนายจ้างหลัก');
                    return;
                }

                const employerToUpdate = allEmployers[parentEmployerIndex];

                if (employerToUpdate.employees && index > -1) {
                    employerToUpdate.employees.splice(index, 1);
                    saveRecords(storageKeys.employers, allEmployers);
                    currentEditingRecord.employees = employerToUpdate.employees;
                    renderEmployeeList();
                    showSuccessMessage('ลบข้อมูลพนักงานเรียบร้อยแล้ว');
                } else {
                    console.error("Invalid index for employee deletion or no employees array.");
                }
            }
            
            function openTerminateEmployeeModal(employeeIndex) {
                document.getElementById('terminateEmployeeForm').reset();
                document.getElementById('terminateEmployeeIndex').value = employeeIndex;
                modals.terminateEmployee.show();
            }

            function handleTerminateEmployee() {
                const employeeIndex = parseInt(document.getElementById('terminateEmployeeIndex').value, 10);
                const terminateDate = document.getElementById('terminateDate').value;

                if (!terminateDate) {
                    alert('กรุณาระบุวันที่แจ้งออก');
                    return;
                }
                
                const employerIndex = parseInt(document.getElementById('employerRecordIndex').value, 10);
                const allEmployers = getRecords(storageKeys.employers);
                const employer = allEmployers[employerIndex];

                const employeeToMove = employer.employees.splice(employeeIndex, 1)[0];
                employeeToMove.terminateDate = terminateDate;

                if (!employer.employmentHistory) {
                    employer.employmentHistory = [];
                }
                employer.employmentHistory.push(employeeToMove);

                saveRecords(storageKeys.employers, allEmployers);
                currentEditingRecord = employer;
                renderEmployeeList();
                renderEmploymentHistory();
                modals.terminateEmployee.hide();
                showSuccessMessage('ย้ายข้อมูลไปยังประวัติการจ้างงานแล้ว');
            }
            
            function handleRestoreHistoryRecord(historyIndex) {
                const employerIndex = parseInt(document.getElementById('employerRecordIndex').value, 10);
                const allEmployers = getRecords(storageKeys.employers);
                const employer = allEmployers[employerIndex];
                
                if (employer.employmentHistory && historyIndex > -1) {
                    const employeeToRestore = employer.employmentHistory.splice(historyIndex, 1)[0];
                    delete employeeToRestore.terminateDate;

                    if (!employer.employees) {
                        employer.employees = [];
                    }
                    employer.employees.push(employeeToRestore);
                    
                    saveRecords(storageKeys.employers, allEmployers);
                    currentEditingRecord = employer;
                    renderEmployeeList();
                    renderEmploymentHistory();
                    showSuccessMessage('กู้คืนข้อมูลพนักงานเรียบร้อยแล้ว');
                }
            }

            function handleDeleteHistoryRecord(historyIndex) {
                 const employerIndex = parseInt(document.getElementById('employerRecordIndex').value, 10);
                 const allEmployers = getRecords(storageKeys.employers);
                 const employer = allEmployers[employerIndex];

                 if (employer.employmentHistory && historyIndex > -1) {
                    employer.employmentHistory.splice(historyIndex, 1);
                    saveRecords(storageKeys.employers, allEmployers);
                    currentEditingRecord = employer;
                    renderEmploymentHistory();
                    showSuccessMessage('ลบข้อมูลประวัติเรียบร้อยแล้ว');
                 }
            }


            function renderEmployeeList(highlightIndex = -1) {
                const listContainer = document.getElementById('employeeList');
                const originalEmployees = currentEditingRecord.employees || [];
                
                const searchTerm = document.getElementById('searchEmployeeInput').value.toLowerCase();
                const searchNationality = document.getElementById('searchEmployeeNationality').value;
                const searchMOUGroup = document.getElementById('searchEmployeeMOUGroup').value;
                const pinkCardFilter = document.getElementById('searchEmployeePinkCard').value; // เพิ่มบรรทัดนี้

                listContainer.innerHTML = '';
                
                const fieldsToSearch = ['employeeNameTh', 'employeeNameEn', 'employeePosition', 'employeePassport', 'employeeWorkPermit', 'namelistNo', 'requestNo', 'workerRefNo', 'personalId', 'companyWorkerId'];

                const filteredEmployees = originalEmployees
                    .map((emp, index) => ({ ...emp, originalIndex: index }))
                    .filter(emp => {
                        const matchesSearchTerm = !searchTerm || fieldsToSearch.some(field => emp[field] && emp[field].toLowerCase().includes(searchTerm));
                        const matchesNationality = !searchNationality || emp.employeeNationality === searchNationality;
                        const matchesMOUGroup = !searchMOUGroup || emp.workPermitMOUGroup === searchMOUGroup;
                        // เพิ่มเงื่อนไขการกรองบัตรชมพู
                        const matchesPinkCard = (pinkCardFilter === 'has_card') ? emp.pinkCardNo : (pinkCardFilter === 'no_card') ? !emp.pinkCardNo : true;

                        return matchesSearchTerm && matchesNationality && matchesMOUGroup && matchesPinkCard; // เพิ่ม matchesPinkCard ในเงื่อนไขสุดท้าย
                    });
                
                const genderCounts = { male: 0, female: 0 };
                filteredEmployees.forEach(emp => {
                    if (['นาย', 'Mr.'].includes(emp.employeeTitleTh) || ['นาย', 'Mr.'].includes(emp.employeeTitleEn)) {
                        genderCounts.male++;
                    } else if (['นาง', 'นางสาว', 'Mrs.', 'Miss'].includes(emp.employeeTitleTh) || ['นาง', 'นางสาว', 'Mrs.', 'Miss'].includes(emp.employeeTitleEn)) {
                        genderCounts.female++;
                    }
                });
                document.getElementById('employeeTotalCount').innerHTML = `ผลลัพธ์: ${filteredEmployees.length} (ชาย: ${genderCounts.male}, หญิง: ${genderCounts.female})`;


                if (filteredEmployees.length === 0) {
                    listContainer.innerHTML = `<p class="text-muted">ไม่พบพนักงานที่ตรงกับเงื่อนไข</p>`;
                } else {
                    filteredEmployees.forEach((emp, displayIndex) => {
                        const flagSrc = flagMap[emp.employeeNationality] || '';
                        const nativeLang = nativeLangMap[emp.employeeNationality] || '';
                        const flagImg = flagSrc ? `<img src="${flagSrc}" alt="${emp.employeeNationality}" class="flag-icon"><span class="native-lang">${nativeLang}</span>` : '';
                        const photoSrc = emp.employeePhoto ? emp.employeePhoto.data : 'https://placehold.co/48x48/e2e8f0/6c757d?text=PIC';
                        const passportTypeText = emp.passportType ? ` (${emp.passportType})` : '';

                        const card = document.createElement('div');
                        card.className = 'employee-card d-flex justify-content-between align-items-start gap-3';
                        if (emp.originalIndex === highlightIndex) {
                            card.classList.add('highlight');
                        }
                        card.innerHTML = `
                            <div class="d-flex align-items-center flex-grow-1">
                                <img src="${photoSrc}" class="employee-photo-thumb" alt="Employee Photo">
                                <div class="flex-grow-1">
                                    <p class="mb-0"><strong>${displayIndex + 1}. ${emp.employeeTitleEn || ''} ${emp.employeeNameEn || 'No English Name'}</strong>${flagImg}</p>
                                    <p class="mb-1 text-muted small">${emp.employeeTitleTh || ''} ${emp.employeeNameTh || '<em>(ไม่มีชื่อภาษาไทย)</em>'} (${emp.employeePosition || 'ไม่ระบุตำแหน่ง'})</p>
                                    <p class="mb-1 text-muted small">Passport${passportTypeText}: ${emp.employeePassport || '-'} (หมดอายุ: ${formatDateDisplay(emp.passportExpiryDate)})</p>
                                    <p class="mb-1 text-muted small">Work Permit: ${emp.employeeWorkPermit || '-'} (หมดอายุ: ${formatDateDisplay(emp.workPermitExpiryDate)})</p>
                                    <p class="mb-0 text-muted small">Visa (${emp.workPermitMOUGroup === 'อื่นๆ' ? emp.workPermitMOUGroupOther : emp.workPermitMOUGroup || '-'}) หมดอายุ: ${formatDateDisplay(emp.visaExpiryDate)} | 90-Day: ${formatDateDisplay(emp.ninetyDayReportDate)}</p>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary edit-employee-btn" data-index="${emp.originalIndex}" title="แก้ไข"><i class="bi bi-pencil-fill"></i></button>
                                <button type="button" class="btn btn-outline-warning terminate-employee-btn" data-index="${emp.originalIndex}" title="แจ้งออก/เลิกจ้าง"><i class="bi bi-person-dash-fill"></i></button>
                                <button type="button" class="btn btn-outline-danger delete-employee-btn" data-index="${emp.originalIndex}" title="ลบ"><i class="bi bi-trash-fill"></i></button>
                            </div>
                        `;
                        listContainer.appendChild(card);
                        if (emp.originalIndex === highlightIndex) {
                           setTimeout(()=> card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
                        }
                    });
                }
            }
            
            function renderEmploymentHistory(highlightIndex = -1) {
                const historyContainer = document.getElementById('employmentHistoryList');
                let history = currentEditingRecord.employmentHistory || [];
                const searchTerm = document.getElementById('searchHistoryInput').value.toLowerCase();

                const originalHistory = history.map((h, i) => ({...h, originalIndex: i}));

                if(searchTerm){
                    history = originalHistory.filter(emp => {
                         const fullNameTh = `${emp.employeeTitleTh || ''} ${emp.employeeNameTh || ''}`.toLowerCase();
                         const fullNameEn = `${emp.employeeTitleEn || ''} ${emp.employeeNameEn || ''}`.toLowerCase();
                         return fullNameTh.includes(searchTerm) || fullNameEn.includes(searchTerm) || (emp.employeePassport?.toLowerCase().includes(searchTerm));
                    });
                } else {
                    history = originalHistory;
                }

                historyContainer.innerHTML = '';
                if(history.length === 0) {
                    historyContainer.innerHTML = '<p class="text-muted">ไม่มีประวัติการจ้างงาน</p>';
                    return;
                }

                 history.forEach((emp, displayIndex) => {
                    const flagSrc = flagMap[emp.employeeNationality] || '';
                    const nativeLang = nativeLangMap[emp.employeeNationality] || '';
                    const flagImg = flagSrc ? `<img src="${flagSrc}" alt="${emp.employeeNationality}" class="flag-icon"><span class="native-lang">${nativeLang}</span>` : '';
                    const photoSrc = emp.employeePhoto ? emp.employeePhoto.data : 'https://placehold.co/48x48/e2e8f0/6c757d?text=PIC';

                    const card = document.createElement('div');
                    card.className = 'employee-card bg-light d-flex justify-content-between align-items-start gap-3';
                     if (emp.originalIndex === highlightIndex) {
                        card.classList.add('highlight');
                    }
                    card.innerHTML = `
                         <div class="d-flex align-items-center flex-grow-1">
                            <img src="${photoSrc}" class="employee-photo-thumb" alt="Employee Photo">
                            <div class="flex-grow-1">
                                <p class="mb-0"><strong>${displayIndex + 1}. ${emp.employeeTitleEn || ''} ${emp.employeeNameEn || 'No English Name'}</strong>${flagImg}</p>
                                <p class="mb-1 text-muted small">${emp.employeeTitleTh || ''} ${emp.employeeNameTh || ''} (${emp.employeePosition || 'ไม่ระบุตำแหน่ง'})</p>
                                <p class="mb-0 text-danger small"><strong>เลิกจ้างวันที่:</strong> ${formatDateDisplay(emp.terminateDate)}</p>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-success restore-history-btn" data-index="${emp.originalIndex}" title="กู้คืน"><i class="bi bi-arrow-counterclockwise"></i></button>
                            <button type="button" class="btn btn-outline-danger delete-history-btn" data-index="${emp.originalIndex}" title="ลบถาวร"><i class="bi bi-trash3-fill"></i></button>
                        </div>
                    `;
                    historyContainer.appendChild(card);
                     if (emp.originalIndex === highlightIndex) {
                        setTimeout(()=> card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
                    }
                });
            }

            function renderTable(type, searchTerm = '') {
                const config = {
                    employers: { key: storageKeys.employers, tableId: 'employerRecordsTableBody', columns: ['employerNameTh', 'employerId', 'employerTaxId', 'businessType', 'employerNameEn', 'signerNameTh', 'signerNameEn', 'businessTypeEn', 'regCapital', 'regDate'], displayColumns: ['employerNameTh', 'employerId', 'businessType'], btnClass: 'edit-employer-btn' },
                    importers: { key: storageKeys.importers, tableId: 'importerRecordsTableBody', columns: ['importerNameTh', 'importerId', 'importerSignerTh', 'importerNameEn', 'importerLicenseNo', 'importerLicenseIssueDate', 'importerLicenseExpiryDate', 'importerSignerEn'], displayColumns: ['importerNameTh', 'importerId', 'importerSignerTh'], btnClass: 'edit-importer-btn' },
                    agents: { key: storageKeys.agents, tableId: 'agentRecordsTableBody', columns: ['agentNameEn', 'agentLicense', 'agentPhone', 'agentEmail', 'agentAddress'], displayColumns: ['agentNameEn', 'agentLicense', 'agentPhone'], btnClass: 'edit-agent-btn' },
                    delegates: { key: storageKeys.delegates, tableId: 'delegateRecordsTableBody', columns: ['delegateNameTh', 'delegateId', 'delegatePhone', 'delegateNameEn', 'delegateEmployeeId', 'delegateIssueDate', 'delegateExpiryDate', 'delegateEmail'], displayColumns: ['delegateNameTh', 'delegateId', 'delegatePhone'], btnClass: 'edit-delegate-btn' }
                };
                const { key, tableId, columns, displayColumns, btnClass } = config[type];
                let records = getRecords(key);
                const jobOwners = getRecords(storageKeys.jobOwners);

                if (type === 'employers') {
                    const jobOwnerSearchTerm = searchTerm ? jobOwners.filter(owner => owner.name.toLowerCase().includes(searchTerm.toLowerCase())).map(owner => owner.id) : [];
                    document.getElementById('employerTotalCount').textContent = records.length;
                    if (searchTerm) {
                        const lowerCaseSearchTerm = searchTerm.toLowerCase();
                        records = records.filter(record => {
                             const matchesOwner = record.jobOwnerId && jobOwnerSearchTerm.includes(record.jobOwnerId);
                             const matchesOtherFields = columns.some(col => record[col] && String(record[col]).toLowerCase().includes(lowerCaseSearchTerm));
                             return matchesOwner || matchesOtherFields;
                        });
                    }
                } else if (searchTerm) {
                    const lowerCaseSearchTerm = searchTerm.toLowerCase();
                    records = records.filter(record => {
                        return columns.some(col => record[col] && String(record[col]).toLowerCase().includes(lowerCaseSearchTerm));
                    });
                }


                const tableBody = document.getElementById(tableId);
                tableBody.innerHTML = '';
                if (records.length > 0) {
                    records.forEach((record, index) => {
                        const originalIndex = getRecords(key).findIndex(orig => JSON.stringify(orig) === JSON.stringify(record));
                        const row = tableBody.insertRow();
                        
                        if (type === 'employers') {
                            const owner = jobOwners.find(o => o.id === record.jobOwnerId);
                            const ownerName = owner ? owner.name : '-';
                            row.innerHTML = `<td>${index + 1}</td><td>${record[displayColumns[0]] || ''}</td><td>${record[displayColumns[1]] || ''}</td><td>${record[displayColumns[2]] || ''}</td><td>${ownerName}</td><td class="text-center action-buttons"><button class="btn btn-sm btn-outline-primary ${btnClass}" data-type="${type}" data-index="${originalIndex}" title="แก้ไข"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-outline-danger delete-record-btn" data-type="${type}" data-index="${originalIndex}" title="ลบ"><i class="bi bi-trash3"></i></button></td>`;
                        } else if (type === 'delegates') {
                            const photoSrc = record.delegatePhoto ? record.delegatePhoto.data : 'https://placehold.co/40x40/e2e8f0/6c757d?text=';
                            row.innerHTML = `<td>${index + 1}</td><td><img src="${photoSrc}" class="employee-photo-thumb" style="width:40px;height:40px;margin-right:0;"></td><td>${record[displayColumns[0]] || ''}</td><td>${record[displayColumns[1]] || ''}</td><td>${record[displayColumns[2]] || ''}</td><td class="text-center action-buttons"><button class="btn btn-sm btn-outline-primary ${btnClass}" data-type="${type}" data-index="${originalIndex}" title="แก้ไข"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-outline-danger delete-record-btn" data-type="${type}" data-index="${originalIndex}" title="ลบ"><i class="bi bi-trash3"></i></button></td>`;
                        } else {
                            row.innerHTML = `<td>${index + 1}</td><td>${record[displayColumns[0]] || ''}</td><td>${record[displayColumns[1]] || ''}</td><td>${record[displayColumns[2]] || ''}</td><td class="text-center action-buttons"><button class="btn btn-sm btn-outline-primary ${btnClass}" data-type="${type}" data-index="${originalIndex}" title="แก้ไข"><i class="bi bi-pencil-square"></i></button><button class="btn btn-sm btn-outline-danger delete-record-btn" data-type="${type}" data-index="${originalIndex}" title="ลบ"><i class="bi bi-trash3"></i></button></td>`;
                        }
                    });
                } else {
                    const colspan = tableBody.previousElementSibling.rows[0].cells.length;
                    const row = tableBody.insertRow();
                    row.innerHTML = `<td colspan="${colspan}" class="text-center text-muted py-3">ไม่พบข้อมูล${searchTerm ? 'ที่ตรงกับคำค้นหา' : ''}</td>`;
                }
            }

            function openModalFor(type, index, options = {}) {
                currentRecordType = type;
                const config = {
                    employers: { modal: modals.employer, formId: 'employerForm', label: 'ข้อมูลนายจ้าง', recordIndexId: 'employerRecordIndex', default: { registeredAddresses: [], workplaceAddresses: [], employees: [], employmentHistory: [] } },
                    importers: { modal: modals.importer, formId: 'importerForm', label: 'ข้อมูลบริษัทนำเข้า', recordIndexId: 'importerRecordIndex', default: { importerAddresses: [] } },
                    agents: { modal: modals.agent, formId: 'agentForm', label: 'ข้อมูลเอเจนซี่', recordIndexId: 'agentRecordIndex', default: {} },
                    delegates: { modal: modals.delegate, formId: 'delegateForm', label: 'ข้อมูลพนักงาน', recordIndexId: 'delegateRecordIndex', default: { delegateAddresses: [] } }
                };
                if (!config[type]) {
                    console.error(`Error: Configuration for type "${type}" is undefined.`);
                    return;
                }
                const { modal, formId, label, recordIndexId, default: defaultRecord } = config[type];
                const records = getRecords(storageKeys[type]);
                const form = document.getElementById(formId);
                form.reset();

                const labelId = `${type.slice(0, -1)}InfoModalLabel`;
                
                if (index === -1) {
                    currentEditingRecord = JSON.parse(JSON.stringify(defaultRecord));
                    document.getElementById(labelId).textContent = `เพิ่ม${label}`;
                    if (type === 'employers') {
                        document.getElementById('employerId').value = generateNextId(storageKeys.employers, 'MC-');
                    }
                } else {
                    currentEditingRecord = JSON.parse(JSON.stringify(records[index]));
                    Object.keys(defaultRecord).forEach(prop => {
                        if (!currentEditingRecord[prop]) currentEditingRecord[prop] = defaultRecord[prop];
                    });
                    document.getElementById(labelId).textContent = `แก้ไข${label}`;
                    form.querySelectorAll('input, select, textarea').forEach(el => { if (el.id && currentEditingRecord[el.id] && el.type !== 'file') el.value = currentEditingRecord[el.id]; });
                }
                document.getElementById(recordIndexId).value = index;
                if (type === 'employers' || type === 'importers' || type === 'delegates') {
                    const addressType = type === 'employers' ? 'registered' : type.slice(0, -1);
                    renderAddressList(addressType);
                    if (type === 'employers') renderAddressList('workplace');
                }
                if (type === 'employers') {
                    renderJobOwnerDropdown();
                    document.getElementById('jobOwnerId').value = currentEditingRecord.jobOwnerId || '';
                    document.getElementById('deleteJobOwnerBtn').disabled = !currentEditingRecord.jobOwnerId;
                    document.getElementById('searchEmployeeInput').value = '';
                    document.getElementById('searchHistoryInput').value = '';
                    renderEmployeeList(options.highlightEmployeeIndex);
                    renderEmploymentHistory(options.highlightHistoryIndex);
                }
                if (type === 'employers') {
                // เพิ่มส่วนนี้เพื่อจัดการไฟล์เอกสารนายจ้าง
                tempEmployeeFileData = {}; // ใช้ tempEmployeeFileData ร่วมกันได้
                const displayEl = document.getElementById('employerDocumentFileDisplay');
                displayEl.innerHTML = '';
                if (currentEditingRecord.employerDocumentFile) {
                    displayEl.innerHTML = `<a href="${currentEditingRecord.employerDocumentFile.data}" target="_blank">ดูไฟล์: ${currentEditingRecord.employerDocumentFile.name}</a>`;
                }
            }
                if (type === 'delegates') {
                    tempDelegatePhotoData = {};
                    const preview = document.getElementById('delegatePhotoPreview');
                    if (currentEditingRecord.delegatePhoto) {
                        preview.src = currentEditingRecord.delegatePhoto.data;
                    } else {
                        preview.src = 'https://placehold.co/120x120/f8fafc/6c757d?text=Photo';
                    }
                }
                modal.show();
            }

            function handleSaveRecord() {
                const config = {
                    employers: { key: storageKeys.employers, formId: 'employerForm', recordIndexId: 'employerRecordIndex', renderFn: () => renderTable('employers'), modal: modals.employer },
                    importers: { key: storageKeys.importers, formId: 'importerForm', recordIndexId: 'importerRecordIndex', renderFn: () => renderTable('importers'), modal: modals.importer },
                    agents: { key: storageKeys.agents, formId: 'agentForm', recordIndexId: 'agentRecordIndex', renderFn: () => renderTable('agents'), modal: modals.agent },
                    delegates: { key: storageKeys.delegates, formId: 'delegateForm', recordIndexId: 'delegateRecordIndex', renderFn: () => renderTable('delegates'), modal: modals.delegate }
                };
                const { key, formId, recordIndexId, renderFn, modal } = config[currentRecordType];
                const records = getRecords(key);
                const recordIndex = parseInt(document.getElementById(recordIndexId).value, 10);
                
                document.getElementById(formId).querySelectorAll('input, select, textarea').forEach(el => { if (el.id && el.type !== 'file') currentEditingRecord[el.id] = el.value; });

                if (currentRecordType === 'employers') {
                   
                     Object.assign(currentEditingRecord, tempEmployeeFileData);
                }

                if (currentRecordType === 'delegates') {
                    Object.assign(currentEditingRecord, tempDelegatePhotoData);
                }

                if (currentRecordType === 'employers' && !currentEditingRecord.employerId) {
                    showSuccessMessage('กรุณาระบุรหัสนายจ้าง'); 
                    console.error("Employer ID is missing for employer record.");
                    return; 
                }

                if (recordIndex === -1) {
                    records.push(currentEditingRecord);
                } else {
                    if (currentRecordType === 'delegates' && !currentEditingRecord.delegatePhoto && records[recordIndex].delegatePhoto) {
                        currentEditingRecord.delegatePhoto = records[recordIndex].delegatePhoto;
                    }
                    records[recordIndex] = currentEditingRecord;
                }
                saveRecords(key, records);
                renderFn();
                modal.hide();
                showSuccessMessage('บันทึกข้อมูลเรียบร้อยแล้ว');
            }

            function deleteSingleRecord(type, index) {
                const key = storageKeys[type];
                const records = getRecords(key);
                if (index > -1 && index < records.length) {
                    records.splice(index, 1);
                    saveRecords(key, records);
                    renderTable(type);
                    showSuccessMessage('ลบข้อมูลเรียบร้อยแล้ว');
                } else {
                    console.error("Invalid index for deletion:", index, "Type:", type);
                }
            }

            // --- Job Owner Functions ---
            function renderJobOwnerDropdown() {
                const owners = getRecords(storageKeys.jobOwners);
                const dropdown = document.getElementById('jobOwnerId');
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">-- เลือกเจ้าของงาน --</option>';
                owners.forEach(owner => {
                    dropdown.add(new Option(`${owner.id} - ${owner.name}`, owner.id));
                });
                dropdown.value = currentValue;
            }

            function saveJobOwner() {
                const nameInput = document.getElementById('jobOwnerName');
                const name = nameInput.value.trim();
                if (!name) {
                    alert('กรุณากรอกชื่อเจ้าของงาน');
                    return;
                }
                const owners = getRecords(storageKeys.jobOwners);
                const newOwner = {
                    id: generateNextId(storageKeys.jobOwners, 'NN-'),
                    name: name
                };
                owners.push(newOwner);
                saveRecords(storageKeys.jobOwners, owners);
                renderJobOwnerDropdown();
                document.getElementById('jobOwnerId').value = newOwner.id; // Auto-select new owner
                modals.jobOwner.hide();
                nameInput.value = '';
            }
            
            function handleDeleteJobOwner() {
                const ownerIdToDelete = document.getElementById('jobOwnerId').value;
                if (!ownerIdToDelete) return;

                recordToProcess = { type: 'jobOwner', id: ownerIdToDelete };
                const owner = getRecords(storageKeys.jobOwners).find(o => o.id === ownerIdToDelete);
                document.getElementById('confirmDeleteModalBody').textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบเจ้าของงาน "${owner.name}" (${owner.id})? การกระทำนี้จะลบข้อมูลออกจากนายจ้างทั้งหมดที่ใช้งานอยู่`;
                modals.confirmDelete.show();
            }


            // --- Notification System ---
            const notificationConfig = {
                '90day': {
                    containerId: 'notification90DayListContainer', paginationId: 'pagination-90day-controls', badgeId: 'notification-90day-badge', countId: '90dayCount',
                    searchInputId: 'search-90day-input', searchMonthId: 'search-90day-month', searchNationalityId: 'search-90day-nationality', searchMOUId: 'search-90day-mou',
                    dateField: 'ninetyDayReportDate', threshold: 45, dangerDays: 30, title: 'รายงานตัว 90 วัน'
                },
                'passport': {
                    containerId: 'notificationPassportListContainer', paginationId: 'pagination-passport-controls', badgeId: 'notification-passport-badge', countId: 'passportCount',
                    searchInputId: 'search-passport-input', searchMonthId: 'search-passport-month', searchNationalityId: 'search-passport-nationality', searchMOUId: 'search-passport-mou',
                    dateField: 'passportExpiryDate', threshold: 45, dangerDays: 15, title: 'Passport'
                },
                'workPermit': {
                    containerId: 'notificationWorkPermitListContainer', paginationId: 'pagination-workPermit-controls', countId: 'workPermitCount',
                    searchInputId: 'search-permits-input', searchMonthId: 'search-permits-month', searchNationalityId: 'search-permits-nationality', searchMOUId: 'search-permits-mou',
                    dateField: 'workPermitExpiryDate', threshold: 45, dangerDays: 15, title: 'ใบอนุญาตทำงาน'
                },
                 'workPermitExpired': {
                    containerId: 'notificationWorkPermitExpiredListContainer', paginationId: 'pagination-workPermitExpired-controls', countId: 'workPermitExpiredCount',
                    searchInputId: 'search-permits-input', searchMonthId: 'search-permits-month', searchNationalityId: 'search-permits-nationality', searchMOUId: 'search-permits-mou',
                    dateField: 'workPermitExpiryDate', threshold: 0, dangerDays: 0, title: 'ขาดต่อขอรับใหม่'
                },
                'visa': {
                    containerId: 'notificationVisaListContainer', paginationId: 'pagination-visa-controls', countId: 'visaCount',
                    searchInputId: 'search-permits-input', searchMonthId: 'search-permits-month', searchNationalityId: 'search-permits-nationality', searchMOUId: 'search-permits-mou',
                    dateField: 'visaExpiryDate', threshold: 60, dangerDays: 30, title: 'วีซ่า'
                },
                'ci_renew': {
                    containerId: 'notificationCi_renewListContainer', paginationId: 'pagination-ci_renew-controls', badgeId: 'notification-ci_renew-badge', countId: 'ci_renewCount',
                    searchInputId: 'search-ci_renew-input', searchMonthId: 'search-ci_renew-month', searchNationalityId: 'search-ci_renew-nationality', searchMOUId: 'search-ci_renew-mou',
                    dateField: 'passportExpiryDate', threshold: 548, dangerDays: 90, title: 'ต่ออายุ เล่ม CI'
                },
                'resolution_renew': {
                    containerId: 'notificationResolution_renewListContainer', paginationId: 'pagination-resolution_renew-controls', badgeId: 'notification-resolution_renew-badge', countId: 'resolution_renewCount',
                    searchInputId: 'search-resolution_renew-input', searchMonthId: 'search-resolution_renew-month', searchNationalityId: 'search-resolution_renew-nationality', searchMOUId: 'search-resolution_renew-mou',
                    dateField: 'workPermitExpiryDate', threshold: 548, dangerDays: 90, title: 'ต่ออายุมติในประเทศ'
                },
                'cancelled_renew': {
                    containerId: 'notificationCancelled_renewListContainer', paginationId: 'pagination-cancelled_renew-controls', badgeId: 'notification-cancelled_renew-badge', countId: 'cancelled_renewCount',
                    searchInputId: 'search-cancelled_renew-input', // <-- เพิ่มบรรทัดนี้
                    searchMonthId: 'search-cancelled_renew-month',
                    searchNationalityId: 'search-cancelled_renew-nationality', // <-- เพิ่มบรรทัดนี้
                    searchMOUId: 'search-cancelled_renew-mou', // <-- เพิ่มบรรทัดนี้
                    dateField: 'workPermitExpiryDate', threshold: 9999, dangerDays: 0, title: 'รายการที่ยกเลิก'
                },
                
            };

            function getUpcomingExpiries(dateField, daysThreshold) {
                const allEmployers = getRecords(storageKeys.employers);
                const allExpiries = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                allEmployers.forEach((employer, employerIndex) => {
                    const processList = (list, listType) => {
                        if (!list || list.length === 0) return;
                        list.forEach((employee, employeeIndexInList) => {
                            let employeeIndexInMainArray = -1;
                            if (listType === 'employees') {
                                employeeIndexInMainArray = employeeIndexInList;
                            } else { // 'employmentHistory'
                                // Find original index if needed, but for now, index within history list is okay.
                                // We are mostly interested in active employees for renewals.
                            }

                            employee = initializeEmployeeSubData(employee); // Ensure sub-data exists
                            if (employee[dateField]) {
                                const expiryDate = new Date(employee[dateField]);
                                expiryDate.setHours(0, 0, 0, 0);
                                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));

                                if (daysRemaining <= daysThreshold) {
                                    allExpiries.push({
                                        employerName: employer.employerNameTh || 'N/A',
                                        employerId: employer.employerId || '',
                                        employee: employee,
                                        expiryDate: expiryDate,
                                        daysRemaining: daysRemaining,
                                        employerIndex: employerIndex,
                                        employeeIndex: employeeIndexInMainArray,
                                        listType: listType
                                    });
                                }
                            }
                        });
                    };
                    processList(employer.employees, 'employees');
                    processList(employer.employmentHistory, 'employmentHistory');
                });
                return allExpiries;
            }

            function renderPagination(type, currentPage, totalPages) {
                const { paginationId } = notificationConfig[type];
                const container = document.getElementById(paginationId);
                container.innerHTML = '';

                if (totalPages <= 1) return;

                let paginationHtml = `<ul class="pagination justify-content-center pagination-sm">`;
                paginationHtml += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}" data-type="${type}">ก่อนหน้า</a></li>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}" data-type="${type}">${i}</a></li>`;
                }
                paginationHtml += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}" data-type="${type}">ถัดไป</a></li>`;
                paginationHtml += `</ul>`;
                container.innerHTML = paginationHtml;
            }
            
            function getFilteredNotifications(type) {
                const config = notificationConfig[type];
                const { dateField, threshold, searchInputId, searchMonthId, searchNationalityId, searchMOUId } = config;
                
                let fetchThreshold = (type === 'workPermit' || type === 'workPermitExpired') ? 45 : threshold;
                let allExpiries = getUpcomingExpiries(dateField, fetchThreshold);
                let relevantExpiries;

                if (type === 'workPermit') {
                    relevantExpiries = allExpiries.filter(item => item.daysRemaining > 0 && item.listType === 'employees' && !item.employee.cancellations[type]);
                } else if (type === 'workPermitExpired') {
                    relevantExpiries = allExpiries.filter(item => item.daysRemaining <= 0 && item.daysRemaining >= -30 && item.listType === 'employees' && !item.employee.cancellations[type]);
                } else if (type === 'ci_renew' || type === 'resolution_renew') {
                    relevantExpiries = allExpiries.filter(item => item.daysRemaining <= threshold && item.listType === 'employees' && !item.employee.cancellations[type]);
                } else if (type === 'cancelled_renew') {
                    const allCancelled = [];
                    const allEmployers = getRecords(storageKeys.employers);
                    allEmployers.forEach((employer, employerIndex) => {
                        if (employer.employees) {
                            employer.employees.forEach((employee, employeeIndex) => {
                                employee = initializeEmployeeSubData(employee); // Ensure data is clean
                                if (employee.cancellations && Object.keys(employee.cancellations).length > 0) {
                                    Object.entries(employee.cancellations).forEach(([cancelledType, isCancelled]) => {
                                        if (isCancelled) {
                                            const config = notificationConfig[cancelledType];
                                            if (config) {
                                                const dateField = config.dateField;
                                                const expiryDate = employee[dateField] ? new Date(employee[dateField]) : null;
                                                allCancelled.push({
                                                    employerName: employer.employerNameTh,
                                                    employerId: employer.employerId,
                                                    employee: employee,
                                                    expiryDate: expiryDate,
                                                    employerIndex: employerIndex,
                                                    employeeIndex: employeeIndex,
                                                    cancelledType: cancelledType, // ระบุประเภทที่ถูกยกเลิก
                                                    title: config.title,
                                                    listType: 'employees'
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });
                    relevantExpiries = allCancelled;
                } else if (type === 'workPermit') {
                    relevantExpiries = allExpiries.filter(item => item.daysRemaining > 0 && item.listType === 'employees' && !item.employee.cancellations[type]);
                } else if (type === 'workPermitExpired') {
                    relevantExpiries = allExpiries.filter(item => item.daysRemaining <= 0 && item.daysRemaining >= -30 && item.listType === 'employees' && !item.employee.cancellations[type]);
                } else {
                    // เงื่อนไขสำหรับ 90day, passport, visa
                    relevantExpiries = allExpiries.filter(item => {
                        const emp = item.employee;
                        //-- เพิ่มเงื่อนไข: ถ้าเป็นพนักงานเมียนมาและใช้เล่ม CI จะไม่นำมาแสดงในส่วนนี้ --
                        const isMyanmarCI = emp.employeeNationality === 'เมียนมา' && emp.passportType === 'CI';
                        return item.listType === 'employees' && !emp.cancellations[type] && !isMyanmarCI;
                    });
                }

                let filteredExpiries = relevantExpiries;
                
                // Specific filters for new notification types
                if (type === 'ci_renew') {
                    filteredExpiries = filteredExpiries.filter(item =>
                        item.employee.employeeNationality === 'เมียนมา' && 
                        item.employee.passportType === 'CI' &&
                        ['มติต่ออายุในประเทศ', 'มติขึ้นทะเบียน'].includes(item.employee.workPermitMOUGroup)
                    );
                } else if (type === 'resolution_renew') {
                     filteredExpiries = filteredExpiries.filter(item => 
                        ['มติต่ออายุในประเทศ', 'มติขึ้นทะเบียน'].includes(item.employee.workPermitMOUGroup)
                    );
                }


                const searchInput = searchInputId ? document.getElementById(searchInputId) : null;
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                
                const monthSelect = searchMonthId ? document.getElementById(searchMonthId) : null;
                const searchMonth = monthSelect ? monthSelect.value : '';

                const nationalitySelect = searchNationalityId ? document.getElementById(searchNationalityId) : null;
                const searchNationality = nationalitySelect ? nationalitySelect.value : '';

                const mouSelect = searchMOUId ? document.getElementById(searchMOUId) : null;
                const searchMOU = mouSelect ? mouSelect.value : '';

                if (searchTerm) {
                    filteredExpiries = filteredExpiries.filter(item => {
                        const emp = item.employee;
                        const fullNameTh = `${emp.employeeTitleTh || ''} ${emp.employeeNameTh || ''}`.toLowerCase();
                        const fullNameEn = `${emp.employeeTitleEn || ''} ${emp.employeeNameEn || ''}`.toLowerCase();
                        return item.employerName.toLowerCase().includes(searchTerm) ||
                               item.employerId.toLowerCase().includes(searchTerm) ||
                               fullNameTh.includes(searchTerm) ||
                               fullNameEn.includes(searchTerm) ||
                               (emp.employeeWorkPermit && emp.employeeWorkPermit.toLowerCase().includes(searchTerm));
                    });
                }

                if (searchMonth) {
                    filteredExpiries = filteredExpiries.filter(item => item.expiryDate && item.expiryDate.getMonth() == parseInt(searchMonth, 10));
                }
                if (searchNationality) {
                    filteredExpiries = filteredExpiries.filter(item => item.employee.employeeNationality === searchNationality);
                }
                if (searchMOU) {
                    filteredExpiries = filteredExpiries.filter(item => item.employee.workPermitMOUGroup === searchMOU);
                }
                
                // === เพิ่มโค้ดส่วนนี้เข้าไป ===
                if (type === 'resolution_renew') {
                    const searchStep = document.getElementById('search-resolution_renew-step').value;
                    if (searchStep) {
                        filteredExpiries = filteredExpiries.filter(item => {
                            const data = item.employee.taskTrackingData || {};
                            switch(searchStep) {
                                case 'not_started': return !data.step1_checked;
                                case 'step1': return data.step1_checked && !data.step2_checked;
                                case 'step2': return data.step2_checked && !data.step3_checked;
                                case 'step3': return data.step3_checked && !data.step4_checked;
                                case 'step4': return data.step4_checked && !data.step5_checked;
                                case 'step5': return data.step5_checked && !data.step6_checked;
                                case 'step6': return data.step6_checked;
                                default: return true;
                            }
                        });
                    }
                }
                // === สิ้นสุดส่วนที่เพิ่ม ===

                filteredExpiries.sort((a,b) => a.expiryDate - b.expiryDate);
                return filteredExpiries;
            }

            function generateTaskProgressHtml(taskData) {
                if (!taskData) return '';

                const steps = [
                    { key: 'step6', name: 'ขั้นตอนที่ 6: อนุมัติ' },
                    { key: 'step5', name: 'ขั้นตอนที่ 5: ยื่นชำระเงิน' },
                    { key: 'step4', name: 'ขั้นตอนที่ 4: ' + (taskData.step4_choice || 'ซื้อประกัน') },
                    { key: 'step3', name: 'ขั้นตอนที่ 3: ใบแพทย์' },
                    { key: 'step2', name: 'ขั้นตอนที่ 2: อนุมัติคำขอ' },
                    { key: 'step1', name: 'ขั้นตอนที่ 1: ยื่นคำขอ' }
                ];

                let lastCompletedStep = 'ยังไม่เริ่มดำเนินการ';
                for (const step of steps) {
                    if (taskData[step.key + '_checked']) {
                        lastCompletedStep = step.name;
                        break; // เจอขั้นตอนล่าสุดที่ทำแล้ว ออกจาก loop
                    }
                }
                
                if (taskData.step6_checked) {
                     return `<p class="small text-success mb-0 mt-1"><strong>สถานะ:</strong> ${lastCompletedStep} (เสร็จสิ้น)</p>`;
                }

                if(lastCompletedStep !== 'ยังไม่เริ่มดำเนินการ') {
                    return `<p class="small text-primary mb-0 mt-1"><strong>สถานะ:</strong> ${lastCompletedStep}</p>`;
                }

                return `<p class="small text-muted mb-0 mt-1"><strong>สถานะ:</strong> ${lastCompletedStep}</p>`;
            }
            function renderNotifications(type) {
                console.log('value type = ' + type);
                const config = notificationConfig[type];
                console.log('value type = ' + config);
                const { containerId, dangerDays, title, countId, badgeId } = config;
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const filteredExpiries = getFilteredNotifications(type);

                const filteredCount = filteredExpiries.length;
                
                if (countId) {
                    document.getElementById(countId).textContent = filteredCount;
                }
                
                if (badgeId) {
                    const badgeEl = document.getElementById(badgeId);
                    badgeEl.textContent = filteredCount > 0 ? filteredCount : '0';
                }

                const currentPage = currentPages[type];
                const totalPages = Math.ceil(filteredCount / ITEMS_PER_PAGE);
                const paginatedItems = filteredExpiries.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

                if (filteredCount === 0) {
                    container.innerHTML = `<div class="alert alert-light text-center">ไม่มีรายการแจ้งเตือน</div>`;
                    renderPagination(type, 0, 0);
                    return;
                }

                paginatedItems.forEach((item, index) => {
                    const itemNumber = ((currentPage - 1) * ITEMS_PER_PAGE) + index + 1;
                    let alertClass;

                    if (type === 'workPermitExpired') {
                        alertClass = 'alert-warning';
                    } else if (type === 'cancelled_renew') {
                        alertClass = 'alert-info';
                    } else {
                        alertClass = 'alert-secondary';
                        if (item.daysRemaining < 0) {
                            alertClass = 'alert-dark';
                        } else if (item.daysRemaining <= dangerDays) {
                            alertClass = 'alert-danger';
                        }
                    }

                    let daysRemainingText = item.daysRemaining < 0 ? `หมดอายุแล้ว ${Math.abs(item.daysRemaining)} วัน` : `เหลือ ${item.daysRemaining} วัน`;
                    
                    const flagSrc = flagMap[item.employee.employeeNationality] || '';
                    const nativeLang = nativeLangMap[item.employee.employeeNationality] || '';
                    const flagImg = flagSrc ? `<img src="${flagSrc}" alt="${item.employee.employeeNationality}" class="flag-icon"><span class="native-lang">${nativeLang}</span>` : '';
                    
                    const photoSrc = item.employee.employeePhoto ? item.employee.employeePhoto.data : 'https://placehold.co/48x48/e2e8f0/6c757d?text=PIC';

                    const formattedDate = formatDateDisplay(item.expiryDate);

                    const card = document.createElement('div');
                    card.className = `alert ${alertClass} notification-item`;
                    
                    let buttonsHtml = '';
                    let extraDetails = '';
                    if (type === 'cancelled_renew') {
                        buttonsHtml = `
                            <button type="button" class="btn btn-info btn-sm view-employee-btn" title="ดูข้อมูล" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}" data-list-type="${item.listType}"><i class="bi bi-search"></i></button>
                            <button type="button" class="btn btn-success btn-sm restore-renewal-btn" title="นำกลับ" data-type="${item.cancelledType}" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}"><i class="bi bi-arrow-counterclockwise"></i> นำกลับ</button>
                        `;
                        extraDetails = `<p class="mb-0 small text-warning"><strong>ยกเลิกการต่ออายุ:</strong> ${item.title}</p>
                        `;
                    } else if (type === 'resolution_renew') {
                        buttonsHtml = `
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-info view-employee-btn" title="ดูข้อมูล" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}" data-list-type="${item.listType}"><i class="bi bi-search"></i></button>
                                <button type="button" class="btn btn-primary track-task-btn" title="ติดตามงาน" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}"><i class="bi bi-clipboard-check"></i></button>
                                <button type="button" class="btn btn-warning cancel-renewal-btn" title="ยกเลิกการต่ออายุ" data-type="${type}" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}"><i class="bi bi-x-circle"></i></button>
                            </div>
                        `;
                   } else {
                         buttonsHtml = `
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-info view-employee-btn" title="ดูข้อมูล" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}" data-list-type="${item.listType}"><i class="bi bi-search"></i></button>
                                <button type="button" class="btn btn-success renew-btn" title="ต่ออายุ" data-type="${type}" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}"><i class="bi bi-calendar-check"></i></button>
                                <button type="button" class="btn btn-warning cancel-renewal-btn" title="ยกเลิกการต่ออายุ" data-type="${type}" data-employer-index="${item.employerIndex}" data-employee-index="${item.employeeIndex}"><i class="bi bi-x-circle"></i></button>
                            </div>
                        `;
                    }
                    
                    let resolutionDetails = '';
                    let taskProgressHtml = ''; // เพิ่มตัวแปรนี้
                    if(type === 'resolution_renew') {
                        resolutionDetails = `
                            <p class="mb-0 small text-muted"><strong>Namelist:</strong> ${item.employee.namelistNo || '-'} | <strong>คำขอ:</strong> ${item.employee.requestNo || '-'} | <strong>อ้างอิง:</strong> ${item.employee.workerRefNo || '-'}</p>
                        `;
                        taskProgressHtml = generateTaskProgressHtml(item.employee.taskTrackingData); // เรียกใช้ฟังก์ชันใหม่
                    }

                    card.innerHTML = `
                        <div class="d-flex align-items-center gap-3">
                            <img src="${photoSrc}" class="employee-photo-thumb" alt="Employee Photo" style="margin-right:0;">
                            <div class="d-flex justify-content-between align-items-start w-100">
                                <div class="flex-grow-1">
                                    <h5 class="alert-heading mb-1">${itemNumber}. ${item.employee.employeeTitleEn || ''} ${item.employee.employeeNameEn || 'N/A'}${flagImg}</h5>
                                    <p class="mb-1"><strong>นายจ้าง:</strong> ${item.employerName}</p>
                                    <p class="mb-0 small"><strong>วันหมดอายุ ${title}:</strong> ${formattedDate}</p>
                                    ${extraDetails} <!-- << เพิ่มตัวแปรนี้เข้ามาตรงนี้ -->
                                    ${taskProgressHtml}
                                </div>
                                <div class="text-end flex-shrink-0 ms-2">
                                    <span class="badge bg-dark mb-2 d-block text-nowrap">${daysRemainingText}</span>
                                    ${buttonsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
                renderPagination(type, currentPage, totalPages);
            }

            function updateNotificationBadges() {
                const counts = {
                    '90day': getFilteredNotifications('90day').length,
                    'passport': getFilteredNotifications('passport').length,
                    'workPermit': getFilteredNotifications('workPermit').length,
                    'workPermitExpired': getFilteredNotifications('workPermitExpired').length,
                    'visa': getFilteredNotifications('visa').length,
                    'ci_renew': getFilteredNotifications('ci_renew').length,
                    'resolution_renew': getFilteredNotifications('resolution_renew').length,
                    'cancelled_renew': getFilteredNotifications('cancelled_renew').length
                };

                document.getElementById('notification-90day-badge').textContent = counts['90day'];
                document.getElementById('notification-passport-badge').textContent = counts['passport'];
                document.getElementById('notification-ci_renew-badge').textContent = counts['ci_renew'];
                document.getElementById('notification-resolution_renew-badge').textContent = counts['resolution_renew'];
                document.getElementById('notification-cancelled_renew-badge').textContent = counts['cancelled_renew'];
                
                const permitsTotal = counts.workPermit + counts.workPermitExpired + counts.visa;
                const permitsBadge = document.getElementById('notification-permits-badge');
                permitsBadge.textContent = permitsTotal;

                const total = counts['90day'] + counts.passport + permitsTotal + counts['ci_renew'] + counts['resolution_renew'];
                const totalBadge = document.getElementById('notification-total-badge');
                totalBadge.textContent = total;
                totalBadge.style.display = total > 0 ? 'inline-block' : 'none';
            }
            
            function openRenewModal(type, employerIndex, employeeIndex) {
                const records = getRecords(storageKeys.employers);
                const employee = records[employerIndex].employees[employeeIndex];
                const { title, dateField } = notificationConfig[type];
                
                document.getElementById('renewModalLabel').textContent = `ต่ออายุ ${title}`;
                document.getElementById('renewDate').value = employee[dateField] || '';
                document.getElementById('renewEmployerIndex').value = employerIndex;
                document.getElementById('renewEmployeeIndex').value = employeeIndex;
                document.getElementById('renewType').value = type;
                modals.renew.show();
            }

            function handleViewEmployee(employerIndex, employeeIndex, listType) {
                // Switch to employer pane
                document.getElementById('nav-employer-system-pane').click();
                
                // Open the correct employer modal and highlight the employee
                const options = {};
                if (listType === 'employees') {
                    options.highlightEmployeeIndex = employeeIndex;
                } else if (listType === 'employmentHistory') {
                    options.highlightHistoryIndex = employeeIndex;
                }

                openModalFor('employers', employerIndex, options);
            }

            // --- Task Tracking Functions ---
            function openTaskTrackingModal(employerIndex, employeeIndex) {
                const allEmployers = getRecords(storageKeys.employers);

                if (!allEmployers[employerIndex] || !allEmployers[employerIndex].employees[employeeIndex]) {
                    console.error("Employee or employer not found for task tracking.");
                    showSuccessMessage("เกิดข้อผิดพลาด: ไม่พบข้อมูลพนักงาน");
                    return;
                }
                
                let employee = initializeEmployeeSubData(allEmployers[employerIndex].employees[employeeIndex]);
                allEmployers[employerIndex].employees[employeeIndex] = employee; // Make sure the initialized version is in the main array
                saveRecords(storageKeys.employers, allEmployers); // Save in case it was a new initialization
                
                document.getElementById('taskTrackingEmployerIndex').value = employerIndex;
                document.getElementById('taskTrackingEmployeeIndex').value = employeeIndex;

                document.getElementById('taskNamelistNo').value = employee.namelistNo || '';
                document.getElementById('taskRequestNo').value = employee.requestNo || '';
                document.getElementById('taskWorkerRefNo').value = employee.workerRefNo || '';
                
                const trackingData = employee.taskTrackingData;
                for (let i = 1; i <= 6; i++) {
                    const checkedEl = document.getElementById(`step${i}_checked`);
                    const dateEl = document.getElementById(`step${i}_date`);
                    const itemEl = document.getElementById(`step${i}-item`);
                    
                    checkedEl.checked = trackingData[`step${i}_checked`];
                    dateEl.value = trackingData[`step${i}_date`] || '';
                    itemEl.classList.toggle('completed', checkedEl.checked);

                    if (i === 4) {
                        document.getElementById('step4_choice').value = trackingData.step4_choice || 'ซื้อประกัน';
                    }
                }
                checkAllStepsCompleted();
                modals.taskTracking.show();
            }

            function saveTaskTrackingProgress() {
                const employerIndex = parseInt(document.getElementById('taskTrackingEmployerIndex').value, 10);
                const employeeIndex = parseInt(document.getElementById('taskTrackingEmployeeIndex').value, 10);

                const allEmployers = getRecords(storageKeys.employers);
                const employee = allEmployers[employerIndex].employees[employeeIndex];

                // Save Namelist, etc.
                employee.namelistNo = document.getElementById('taskNamelistNo').value;
                employee.requestNo = document.getElementById('taskRequestNo').value;
                employee.workerRefNo = document.getElementById('taskWorkerRefNo').value;

                // Save tracking data
                const trackingData = employee.taskTrackingData;
                for (let i = 1; i <= 6; i++) {
                    trackingData[`step${i}_checked`] = document.getElementById(`step${i}_checked`).checked;
                    trackingData[`step${i}_date`] = document.getElementById(`step${i}_date`).value;
                    if (i === 4) {
                        trackingData.step4_choice = document.getElementById('step4_choice').value;
                    }
                }
                
                saveRecords(storageKeys.employers, allEmployers);
                renderNotifications('resolution_renew'); // Refresh the list
                showSuccessMessage('บันทึกขั้นตอนการทำงานเรียบร้อยแล้ว');
            }

            function checkAllStepsCompleted() {
                let allCompleted = true;
                for (let i = 1; i <= 6; i++) {
                    if (!document.getElementById(`step${i}_checked`).checked) {
                        allCompleted = false;
                        break;
                    }
                }
                document.getElementById('triggerRenewButton').disabled = !allCompleted;
            }

            function handleRenewalCancellation(employerIndex, employeeIndex, type, cancel) {
                const allEmployers = getRecords(storageKeys.employers);
                const employer = allEmployers[employerIndex];
                if (!employer || !employer.employees || !employer.employees[employeeIndex]) {
                    console.error("Cannot find employee to cancel/restore renewal.");
                    showSuccessMessage('เกิดข้อผิดพลาด: ไม่พบข้อมูลพนักงาน');
                    return;
                }
                const employee = employer.employees[employeeIndex];

                // อัปเดตสถานะการยกเลิกตามประเภท
                if (!employee.cancellations) employee.cancellations = {};
                employee.cancellations[type] = cancel;
                
                saveRecords(storageKeys.employers, allEmployers);
                
                // อัปเดตเฉพาะแท็บที่เกี่ยวข้องเพื่อประสิทธิภาพที่ดีขึ้น
                renderNotifications(type);
                renderNotifications('cancelled_renew');
                updateNotificationBadges();

                showSuccessMessage(cancel ? 'ยกเลิกการต่ออายุเรียบร้อย' : 'นำกลับเข้าสู่กระบวนการต่ออายุเรียบร้อย');
            }
            
            // --- Dashboard / Charting ---
            function renderDashboard() {
    const yearSelect = document.getElementById('db-year-select');
    const monthSelect = document.getElementById('db-month-select');
    const compareMonthSelect = document.getElementById('db-compare-month-select');

    // --- Setup Filters (Run only once) ---
    if (yearSelect.options.length === 0) {
        const currentYear = new Date().getFullYear();
        for (let i = currentYear; i >= currentYear - 5; i--) {
            yearSelect.add(new Option(i + 543, i));
        }
        const monthNames = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        monthNames.forEach((month, index) => {
            monthSelect.add(new Option(month, index));
            compareMonthSelect.add(new Option(month, index));
        });
        yearSelect.value = currentYear;
        monthSelect.value = 'all';
        compareMonthSelect.value = '';

        // Add event listeners
        yearSelect.addEventListener('change', renderDashboard);
        monthSelect.addEventListener('change', renderDashboard);
        compareMonthSelect.addEventListener('change', renderDashboard);
    }

    // --- Get Filter Values ---
    const selectedYear = parseInt(yearSelect.value, 10);
    const selectedMonth = monthSelect.value; // 'all' or 0-11
    const compareMonth = compareMonthSelect.value; // '' or 0-11

    // --- Filter Data ---
    const allEmployers = getRecords(storageKeys.employers);
    const allEmployees = allEmployers.flatMap(employer => employer.employees || []);

    const filterEmployeesByMonth = (employees, year, month) => {
        if (month === 'all' || month === '') {
            return employees.filter(emp => new Date(emp.startDate).getFullYear() === year);
        }
        return employees.filter(emp => {
            const startDate = new Date(emp.startDate);
            return startDate.getFullYear() === year && startDate.getMonth() == month;
        });
    };

    const mainDataEmployees = filterEmployeesByMonth(allEmployees, selectedYear, selectedMonth);
    const compareDataEmployees = compareMonth !== '' ? filterEmployeesByMonth(allEmployees, selectedYear, compareMonth) : null;

    // --- Update KPI Cards ---
    // Showing total counts regardless of filter for main KPIs
    document.getElementById('db-total-employers').textContent = allEmployers.length;
    document.getElementById('db-total-employees').textContent = allEmployees.length;
    document.getElementById('db-total-notifications').textContent = document.getElementById('notification-total-badge').textContent || '0';

    // --- Render Charts ---
    const chartColors = ['#F97316', '#3B82F6', '#10B981', '#F59E0B', '#6366F1', '#EC4899'];

    // Nationality Chart
    const nationalityCtx = document.getElementById('nationalityChart').getContext('2d');
    const mainNationalityCounts = mainDataEmployees.reduce((acc, emp) => {
        const nat = emp.employeeNationality || 'ไม่ระบุ';
        acc[nat] = (acc[nat] || 0) + 1;
        return acc;
    }, {});

    const datasets = [{
        label: `สัญชาติ (${monthSelect.options[monthSelect.selectedIndex].text})`,
        data: Object.values(mainNationalityCounts),
        backgroundColor: chartColors,
        borderColor: '#ffffff',
        borderWidth: 2
    }];

    if (compareDataEmployees) {
        const compareNationalityCounts = compareDataEmployees.reduce((acc, emp) => {
            const nat = emp.employeeNationality || 'ไม่ระบุ';
            acc[nat] = (acc[nat] || 0) + 1;
            return acc;
        }, {});
        const allLabels = [...new Set([...Object.keys(mainNationalityCounts), ...Object.keys(compareNationalityCounts)])];
        const mainDataAligned = allLabels.map(label => mainNationalityCounts[label] || 0);
        const compareDataAligned = allLabels.map(label => compareNationalityCounts[label] || 0);

        if(charts.nationalityChart) charts.nationalityChart.destroy();
        charts.nationalityChart = new Chart(nationalityCtx, {
            type: 'bar',
            data: {
                labels: allLabels,
                datasets: [
                    { label: `${monthSelect.options[monthSelect.selectedIndex].text}`, data: mainDataAligned, backgroundColor: '#F97316' },
                    { label: `${compareMonthSelect.options[compareMonthSelect.selectedIndex].text}`, data: compareDataAligned, backgroundColor: '#3B82F6' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

    } else {
         if(charts.nationalityChart) charts.nationalityChart.destroy();
         charts.nationalityChart = new Chart(nationalityCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(mainNationalityCounts),
                datasets: datasets
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    // MOU Chart
    const mouCtx = document.getElementById('mouChart').getContext('2d');
    const mouCounts = mainDataEmployees.reduce((acc, emp) => {
        let group = emp.workPermitMOUGroup || 'ไม่ระบุ';
        if (group === 'อื่นๆ') group = emp.workPermitMOUGroupOther || 'อื่นๆ (ไม่ระบุ)';
        acc[group] = (acc[group] || 0) + 1;
        return acc;
    }, {});
    if(charts.mouChart) charts.mouChart.destroy();
    charts.mouChart = new Chart(mouCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(mouCounts),
            datasets: [{
                label: 'ประเภท MOU',
                data: Object.values(mouCounts),
                backgroundColor: chartColors.slice().reverse(),
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });

    // Expiry Chart remains unchanged, showing future data
    const expiryCtx = document.getElementById('expiryChart').getContext('2d');
    const expiryLabels = [];
    const today = new Date();
    for (let i = 0; i < 12; i++) {
        const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
        expiryLabels.push(d.toLocaleDateString('th-TH', { month: 'short', year: '2-digit' }));
    }
    const expiryDatasets = {};
    const notificationTypesForChart = ['90day', 'passport', 'workPermit', 'visa'];
    notificationTypesForChart.forEach(type => {
        const config = notificationConfig[type];
        const notifications = getUpcomingExpiries(config.dateField, 365)
            .filter(item => item.listType === 'employees' && !item.employee.isRenewalCancelled && item.daysRemaining > 0);

        const monthlyCounts = Array(12).fill(0);
        notifications.forEach(item => {
            const monthDiff = (item.expiryDate.getFullYear() - today.getFullYear()) * 12 + item.expiryDate.getMonth() - today.getMonth();
            if (monthDiff >= 0 && monthDiff < 12) {
                monthlyCounts[monthDiff]++;
            }
        });
        expiryDatasets[config.title] = monthlyCounts;
    });

    if(charts.expiryChart) charts.expiryChart.destroy();
    charts.expiryChart = new Chart(expiryCtx, {
        type: 'bar',
        data: {
            labels: expiryLabels,
            datasets: [
                { label: '90 วัน', data: expiryDatasets['รายงานตัว 90 วัน'], backgroundColor: '#EF4444' },
                { label: 'Passport', data: expiryDatasets['Passport'], backgroundColor: '#3B82F6' },
                { label: 'Work Permit', data: expiryDatasets['ใบอนุญาตทำงาน'], backgroundColor: '#F59E0B' },
                { label: 'Visa', data: expiryDatasets['วีซ่า'], backgroundColor: '#10B981' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });
}


            // --- Export to CSV Functions ---
            function getValueFromPath(obj, path) {
                return path.split('.').reduce((acc, part) => acc && acc[part], obj);
            }

            function convertToCSV(data, headers) {
                const headerRow = Object.values(headers).join(',');
                const dataRows = data.map(row => {
                    return Object.keys(headers).map(key => {
                        let cell = getValueFromPath(row, key) ?? '';
                        cell = String(cell);
                        if (cell.includes(',') || cell.includes('"') || cell.includes('\n')) {
                            cell = `"${cell.replace(/"/g, '""')}"`;
                        }
                        return cell;
                    }).join(',');
                });
                return [headerRow, ...dataRows].join('\n');
            }

            function downloadCSV(csvString, filename) {
                const blob = new Blob(['\uFEFF' + csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function handleExport(exportType) {
                let data;
                let headers;
                let filename = `${exportType}_${new Date().toISOString().slice(0,10)}.csv`;

                switch (exportType) {
                    case 'employers':
                        data = getRecords(storageKeys.employers);
                        headers = {
                            employerId: 'รหัสนายจ้าง',
                            employerTaxId: 'เลขประจำตัวนายจ้าง',
                            employerNameTh: 'ชื่อนายจ้าง (ไทย)',
                            employerNameEn: 'ชื่อนายจ้าง (อังกฤษ)',
                            signerNameTh: 'ผู้ลงนาม (ไทย)',
                            signerNameEn: 'ผู้ลงนาม (อังกฤษ)',
                            businessType: 'ประเภทกิจการ',
                            regCapital: 'ทุนจดทะเบียน',
                            regDate: 'วันที่จดทะเบียน'
                        };
                        break;
                    case 'importers':
                        data = getRecords(storageKeys.importers);
                        headers = {
                            importerId: 'เลขประจำตัว',
                            importerNameTh: 'ชื่อบริษัท (ไทย)',
                            importerNameEn: 'ชื่อบริษัท (อังกฤษ)',
                            importerLicenseNo: 'เลขที่ใบอนุญาต',
                            importerLicenseIssueDate: 'วันที่ออก',
                            importerLicenseExpiryDate: 'วันที่หมดอายุ',
                            importerSignerTh: 'ผู้ลงนาม (ไทย)',
                            importerSignerEn: 'ผู้ลงนาม (อังกฤษ)'
                        };
                        break;
                    case 'agents':
                        data = getRecords(storageKeys.agents);
                        headers = {
                            agentNameEn: 'ชื่อเอเจนซี่',
                            agentLicense: 'License',
                            agentPhone: 'เบอร์โทรศัพท์',
                            agentEmail: 'อีเมล',
                            agentAddress: 'ที่อยู่'
                        };
                        break;
                    case 'delegates':
                        data = getRecords(storageKeys.delegates);
                        headers = {
                            delegateId: 'เลขประจำตัวประชาชน',
                            delegateNameTh: 'ชื่อ (ไทย)',
                            delegateNameEn: 'ชื่อ (อังกฤษ)',
                            delegateEmployeeId: 'รหัสพนักงาน',
                            delegateIssueDate: 'วันที่ออกบัตร',
                            delegateExpiryDate: 'วันสิ้นสุดบัตร',
                            delegatePhone: 'เบอร์โทรศัพท์',
                            delegateEmail: 'อีเมล'
                        };
                        break;
                    case 'employees':
                        const empSearchTerm = document.getElementById('searchEmployeeInput').value.toLowerCase();
                        const empSearchNationality = document.getElementById('searchEmployeeNationality').value;
                        const empSearchMOUGroup = document.getElementById('searchEmployeeMOUGroup').value;

                        data = (currentEditingRecord.employees || []).filter(emp => {
                            const fullNameTh = `${emp.employeeTitleTh || ''} ${emp.employeeNameTh || ''}`.toLowerCase();
                            const fullNameEn = `${emp.employeeTitleEn || ''} ${emp.employeeNameEn || ''}`.toLowerCase();
                            const matchesSearchTerm = !empSearchTerm || fullNameTh.includes(empSearchTerm) || fullNameEn.includes(empSearchTerm) || (emp.employeePosition?.toLowerCase().includes(empSearchTerm)) || (emp.employeePassport?.toLowerCase().includes(empSearchTerm)) || (emp.employeeWorkPermit?.toLowerCase().includes(empSearchTerm));
                            const matchesNationality = !empSearchNationality || emp.employeeNationality === empSearchNationality;
                            const matchesMOUGroup = !empSearchMOUGroup || emp.workPermitMOUGroup === empSearchMOUGroup;
                            return matchesSearchTerm && matchesNationality && matchesMOUGroup;
                        });

                        headers = {
                            employeeNameEn: 'Name (EN)',
                            employeeNameTh: 'Name (TH)',
                            employeeNationality: 'Nationality',
                            passportType: 'Passport Type',
                            employeePassport: 'Passport No.',
                            passportExpiryDate: 'Passport Expiry',
                            employeeWorkPermit: 'Work Permit No.',
                            workPermitExpiryDate: 'Work Permit Expiry',
                            workPermitMOUGroup: 'MOU Type',
                            visaExpiryDate: 'Visa Expiry',
                            ninetyDayReportDate: '90-Day Report',
                            startDate: 'Start Date',
                            employeePhone: 'Phone',
                            employeePosition: 'Position',
                            pinkCardNo: 'Pink Card No',
                            socialSecurityNo: 'Social Security No',
                            taxIdNo: 'Tax ID',
                            designatedHospital: 'Hospital'
                        };
                        filename = `employees_${currentEditingRecord.employerNameTh || 'export'}_${new Date().toISOString().slice(0,10)}.csv`;
                        break;

                    case 'employmentHistory':
                        const histSearchTerm = document.getElementById('searchHistoryInput').value.toLowerCase();
                        data = (currentEditingRecord.employmentHistory || []).filter(emp => {
                            if (!histSearchTerm) return true;
                            const fullNameTh = `${emp.employeeTitleTh || ''} ${emp.employeeNameTh || ''}`.toLowerCase();
                            const fullNameEn = `${emp.employeeTitleEn || ''} ${emp.employeeNameEn || ''}`.toLowerCase();
                            return fullNameTh.includes(histSearchTerm) || fullNameEn.includes(histSearchTerm) || (emp.employeePassport?.toLowerCase().includes(histSearchTerm));
                        });

                        headers = {
                            employeeNameEn: 'Name (EN)',
                            employeeNameTh: 'Name (TH)',
                            employeeNationality: 'Nationality',
                            employeePassport: 'Passport No.',
                            terminateDate: 'Termination Date',
                            employeePosition: 'Last Position'
                        };
                        filename = `history_${currentEditingRecord.employerNameTh || 'export'}_${new Date().toISOString().slice(0,10)}.csv`;
                        break;
                        case 'cancelled_renew':
    data = getFilteredNotifications(exportType);
    headers = {
        employerName: 'นายจ้าง',
        'employee.employeeNameEn': 'ชื่อพนักงาน (อังกฤษ)',
'employee.employeeNameTh': 'ชื่อพนักงาน (ไทย)',
        'employee.employeeNationality': 'สัญชาติ',
        'employee.employeePassport': 'เลข Passport',
        'employee.employeeWorkPermit': 'เลข Work Permit',
        title: 'ประเภทที่ถูกยกเลิก',
        expiryDate: 'วันหมดอายุเดิม'
    };
    data = data.map(item => ({
        ...item,
        expiryDate: item.expiryDate ? item.expiryDate.toLocaleDateString('en-GB') : '-'
    }));
    break;
                    case '90day':
                    case 'passport':
                    case 'workPermit':
                    case 'workPermitExpired':
                    case 'visa':
                    case 'ci_renew':
                    case 'resolution_renew':
                        data = getFilteredNotifications(exportType);
                        headers = {
                            employerName: 'นายจ้าง',
                            'employee.employeeNameEn': 'ชื่อพนักงาน (อังกฤษ)',
                            'employee.employeeNameTh': 'ชื่อพนักงาน (ไทย)',
                            'employee.employeeNationality': 'สัญชาติ',
                            'employee.passportType': 'ประเภท Passport',
                            'employee.employeePassport': 'เลข Passport',
                            'employee.employeeWorkPermit': 'เลข Work Permit',
                            'employee.workPermitMOUGroup': 'ประเภท มติ.',
                            expiryDate: 'วันหมดอายุ',
                            daysRemaining: 'วันที่เหลือ'
                        };
                        data = data.map(item => ({
                            ...item,
                            expiryDate: item.expiryDate.toLocaleDateString('en-GB')
                        }));
                        break;
                    default:
                        console.error('Unknown export type:', exportType);
                        return;
                }

                if (data && data.length > 0) {
                    const csv = convertToCSV(data, headers);
                    downloadCSV(csv, filename);
                } else {
                    showSuccessMessage('ไม่มีข้อมูลสำหรับส่งออก');
                }
            }


            // --- Initial Setup & Global Listeners ---
            await loadAddressData();
            Object.keys(storageKeys).forEach(type => {
                if(type !== 'jobOwners') renderTable(type)
            });
            updateNotificationBadges();
            
            document.getElementById('addNewEmployerButton').addEventListener('click', () => openModalFor('employers', -1));
            document.getElementById('saveEmployerButton').addEventListener('click', () => { currentRecordType = 'employers'; handleSaveRecord(); });
            document.getElementById('addNewImporterButton').addEventListener('click', () => openModalFor('importers', -1));
            document.getElementById('saveImporterButton').addEventListener('click', () => { currentRecordType = 'importers'; handleSaveRecord(); });
            document.getElementById('addNewAgentButton').addEventListener('click', () => openModalFor('agents', -1));
            document.getElementById('saveAgentButton').addEventListener('click', () => { currentRecordType = 'agents'; handleSaveRecord(); });
            document.getElementById('addNewDelegateButton').addEventListener('click', () => openModalFor('delegates', -1));
            document.getElementById('saveDelegateButton').addEventListener('click', () => { currentRecordType = 'delegates'; handleSaveRecord(); });
            
            document.getElementById('addNewJobOwnerBtn').addEventListener('click', () => modals.jobOwner.show());
            document.getElementById('saveJobOwnerButton').addEventListener('click', saveJobOwner);
            document.getElementById('deleteJobOwnerBtn').addEventListener('click', handleDeleteJobOwner);
            document.getElementById('jobOwnerId').addEventListener('change', (e) => {
                document.getElementById('deleteJobOwnerBtn').disabled = !e.target.value;
            });

            document.getElementById('saveAddressButton').addEventListener('click', handleSaveAddress);
            document.getElementById('confirmTerminateEmployeeButton').addEventListener('click', handleTerminateEmployee);

            document.getElementById('employerInfoModal').addEventListener('click', (e) => {
                if (e.target.closest('.add-address-btn')) {
                    openAddressModal(e.target.closest('.add-address-btn').dataset.type, -1);
                } else if (e.target.closest('.edit-address-btn')) {
                    const btn = e.target.closest('.edit-address-btn');
                    openAddressModal(btn.dataset.type, parseInt(btn.dataset.index, 10));
                } else if (e.target.closest('.delete-address-btn')) {
                    const btn = e.target.closest('.delete-address-btn');
                    handleDeleteAddress(btn.dataset.type, parseInt(btn.dataset.index, 10));
                }
                else if (e.target.closest('.add-employee-btn')) {
                    openEmployeeModal(-1);
                } else if (e.target.closest('.edit-employee-btn')) {
                    const btn = e.target.closest('.edit-employee-btn');
                    openEmployeeModal(parseInt(btn.dataset.index, 10));
                } else if (e.target.closest('.terminate-employee-btn')) {
                    const btn = e.target.closest('.terminate-employee-btn');
                    openTerminateEmployeeModal(parseInt(btn.dataset.index, 10));
                } else if (e.target.closest('.delete-employee-btn')) {
                    recordToProcess = { type: 'employee', employeeIndex: parseInt(e.target.closest('.delete-employee-btn').dataset.index, 10) };
                    document.getElementById('confirmDeleteModalBody').textContent = 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลพนักงานคนนี้?';
                    modals.confirmDelete.show();
                } else if (e.target.closest('.delete-history-btn')) {
                    recordToProcess = { type: 'history', historyIndex: parseInt(e.target.closest('.delete-history-btn').dataset.index, 10) };
                    document.getElementById('confirmDeleteModalBody').textContent = 'คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลประวัติการจ้างงานนี้อย่างถาวร?';
                    modals.confirmDelete.show();
                } else if (e.target.closest('.restore-history-btn')) {
                    recordToProcess = { type: 'restore', historyIndex: parseInt(e.target.closest('.restore-history-btn').dataset.index, 10) };
                    modals.confirmRestore.show();
                }
            });
            
            document.getElementById('confirmRestoreButton').addEventListener('click', () => {
                if (recordToProcess.type === 'restore') {
                    handleRestoreHistoryRecord(recordToProcess.historyIndex);
                }
                modals.confirmRestore.hide();
                recordToProcess = { type: '', index: -1, employeeIndex: null, historyIndex: null, id: null };
            });

            document.getElementById('employerInfoModal').addEventListener('input', (e) => {
                if (['searchEmployeeInput', 'searchEmployeeNationality', 'searchEmployeeMOUGroup', 'searchEmployeePinkCard'].includes(e.target.id)) {
                    renderEmployeeList();
                }
                 if (e.target.id === 'searchHistoryInput') {
                    renderEmploymentHistory();
                }
            });

            document.getElementById('employeeInfoModal').addEventListener('input', (e) => {
                if (e.target.id === 'employeeDob') {
                    const age = calculateAge(e.target.value);
                    document.getElementById('employeeAge').value = age;
                }
            });
            
            document.getElementById('employeeNationality').addEventListener('change', function() {
                const passportTypeRow = document.getElementById('passportTypeRow');
                const myanmarDocsRow = document.getElementById('myanmarDocsRow');
                if (this.value === 'เมียนมา') {
                    passportTypeRow.classList.remove('d-none');
                    myanmarDocsRow.classList.remove('d-none');
                } else {
                    passportTypeRow.classList.add('d-none');
                    document.getElementById('passportType').value = '';
                    myanmarDocsRow.classList.add('d-none');
                }
            });

            document.getElementById('workPermitMOUGroup').addEventListener('change', function() {
                const otherInput = document.getElementById('workPermitMOUGroupOther');
                if (this.value === 'อื่นๆ') {
                    otherInput.classList.remove('d-none');
                } else {
                    otherInput.classList.add('d-none');
                    otherInput.value = '';
                }
            });
            
            const handleFileChange = (event, key, previewElId, displayElId) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = { name: file.name, type: file.type, data: e.target.result };
                    if (key === 'delegatePhoto') {
                        tempDelegatePhotoData[key] = data;
                    } else {
                        tempEmployeeFileData[key] = data;
                    }
                    
                    if (previewElId) {
                        document.getElementById(previewElId).src = e.target.result;
                    }
                    if (displayElId) {
                        document.getElementById(displayElId).innerHTML = `<a href="${e.target.result}" target="_blank">ดูไฟล์: ${file.name}</a>`;
                    }
                };
                reader.readAsDataURL(file);
            };

            document.getElementById('employeePhoto').addEventListener('change', (e) => handleFileChange(e, 'employeePhoto', 'employeePhotoPreview', null));
            document.getElementById('delegatePhoto').addEventListener('change', (e) => handleFileChange(e, 'delegatePhoto', 'delegatePhotoPreview', null));
            document.getElementById('employeePassportFile').addEventListener('change', (e) => handleFileChange(e, 'employeePassportFile', null, 'employeePassportFileDisplay'));
            document.getElementById('employeeWorkPermitFile').addEventListener('change', (e) => handleFileChange(e, 'employeeWorkPermitFile', null, 'employeeWorkPermitFileDisplay'));
            document.getElementById('pinkCardFile').addEventListener('change', (e) => handleFileChange(e, 'pinkCardFile', null, 'pinkCardFileDisplay'));
            document.getElementById('myanmarIdFile').addEventListener('change', (e) => handleFileChange(e, 'myanmarIdFile', null, 'myanmarIdFileDisplay'));
            document.getElementById('myanmarHouseRegFile').addEventListener('change', (e) => handleFileChange(e, 'myanmarHouseRegFile', null, 'myanmarHouseRegFileDisplay'));document.getElementById('employerDocumentFile').addEventListener('change', (e) => handleFileChange(e, 'employerDocumentFile', null, 'employerDocumentFileDisplay'));


            document.getElementById('importerInfoModal').addEventListener('click', (e) => {
                if (e.target.closest('.add-address-btn')) {
                    openAddressModal(e.target.closest('.add-address-btn').dataset.type, -1);
                } else if (e.target.closest('.edit-address-btn')) {
                    const btn = e.target.closest('.edit-address-btn');
                    openAddressModal(btn.dataset.type, parseInt(btn.dataset.index, 10));
                } else if (e.target.closest('.delete-address-btn')) {
                    const btn = e.target.closest('.delete-address-btn');
                    handleDeleteAddress(btn.dataset.type, parseInt(btn.dataset.index, 10));
                }
            });

            document.getElementById('delegateInfoModal').addEventListener('click', (e) => {
                if (e.target.closest('.add-address-btn')) {
                    openAddressModal(e.target.closest('.add-address-btn').dataset.type, -1);
                } else if (e.target.closest('.edit-address-btn')) {
                    const btn = e.target.closest('.edit-address-btn');
                    openAddressModal(btn.dataset.type, parseInt(btn.dataset.index, 10));
                } else if (e.target.closest('.delete-address-btn')) {
                    const btn = e.target.closest('.delete-address-btn');
                    handleDeleteAddress(btn.dataset.type, parseInt(btn.dataset.index, 10));
                }
            });
            
            document.querySelectorAll('tbody').forEach(tbody => {
                tbody.addEventListener('click', (e) => {
                    if (e.target.closest('.btn-outline-primary')) {
                        const btn = e.target.closest('.btn-outline-primary');
                        const type = btn.dataset.type; 
                        openModalFor(type, parseInt(btn.dataset.index, 10));
                    }
                    if (e.target.closest('.delete-record-btn')) {
                        const btn = e.target.closest('.delete-record-btn');
                        recordToProcess = { type: btn.dataset.type, index: parseInt(btn.dataset.index, 10) };
                        document.getElementById('confirmDeleteModalBody').textContent = 'คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?';
                        modals.confirmDelete.show();
                    }
                });
            });

            document.getElementById('notificationTabContent').addEventListener('click', (e) => {
                const renewBtn = e.target.closest('.renew-btn');
                const viewBtn = e.target.closest('.view-employee-btn');
                const trackBtn = e.target.closest('.track-task-btn');
                const cancelBtn = e.target.closest('.cancel-renewal-btn');
                const restoreBtn = e.target.closest('.restore-renewal-btn');

                if (renewBtn) {
                    openRenewModal(
                        renewBtn.dataset.type,
                        parseInt(renewBtn.dataset.employerIndex, 10),
                        parseInt(renewBtn.dataset.employeeIndex, 10)
                    );
                }
                if (viewBtn) {
                    handleViewEmployee(
                        parseInt(viewBtn.dataset.employerIndex, 10),
                        parseInt(viewBtn.dataset.employeeIndex, 10),
                        viewBtn.dataset.listType
                    );
                }
                if (trackBtn) {
                     openTaskTrackingModal(
                        parseInt(trackBtn.dataset.employerIndex, 10),
                        parseInt(trackBtn.dataset.employeeIndex, 10)
                    );
                }
                if (cancelBtn) {
                    recordToProcess = { 
                        type: 'cancelRenewal', 
                        renewalType: cancelBtn.dataset.type, // <-- **จุดสำคัญ:** อ่านค่า data-type จากปุ่ม
                        employerIndex: parseInt(cancelBtn.dataset.employerIndex, 10),
                        employeeIndex: parseInt(cancelBtn.dataset.employeeIndex, 10)
                    };
                    modals.confirmCancelRenewal.show(); // แสดงหน้าต่างยืนยัน
                }
                 if (restoreBtn) {
                    recordToProcess = { 
                        type: 'restoreRenewal', 
                        renewalType: restoreBtn.dataset.type, // <-- **จุดสำคัญ:** อ่านค่า data-type จากปุ่ม
                        employerIndex: parseInt(restoreBtn.dataset.employerIndex, 10),
                        employeeIndex: parseInt(restoreBtn.dataset.employeeIndex, 10)
                    };
                    modals.confirmRestoreRenewal.show(); // แสดงหน้าต่างยืนยัน
                }
            });

            document.getElementById('confirmCancelRenewalButton').addEventListener('click', () => {
                if (recordToProcess.type === 'cancelRenewal') {
                    // **จุดสำคัญ:** ส่ง renewalType ที่เก็บไว้ไปยังฟังก์ชันหลัก
                    handleRenewalCancellation(recordToProcess.employerIndex, recordToProcess.employeeIndex, recordToProcess.renewalType, true);
                }
                modals.confirmCancelRenewal.hide();
            });

            document.getElementById('confirmRestoreRenewalButton').addEventListener('click', () => {
                if (recordToProcess.type === 'restoreRenewal') {
                    // **จุดสำคัญ:** ส่ง renewalType ที่เก็บไว้ไปยังฟังก์ชันหลัก
                    handleRenewalCancellation(recordToProcess.employerIndex, recordToProcess.employeeIndex, recordToProcess.renewalType, false);
                }
                modals.confirmRestoreRenewal.hide();
            });
            
            document.getElementById('saveRenewalButton').addEventListener('click', () => {
                const employerIndex = document.getElementById('renewEmployerIndex').value;
                const employeeIndex = document.getElementById('renewEmployeeIndex').value;
                const newDate = document.getElementById('renewDate').value;
                const type = document.getElementById('renewType').value;
                
                const records = getRecords(storageKeys.employers);
                const { dateField } = notificationConfig[type];

                if (dateField) {
                    records[employerIndex].employees[employeeIndex][dateField] = newDate;
                    saveRecords(storageKeys.employers, records);
                    modals.renew.hide();
                    
                    Object.keys(notificationConfig).forEach(type => renderNotifications(type));
                    updateNotificationBadges();

                    showSuccessMessage('ต่ออายุเรียบร้อยแล้ว');
                }
            });

            document.getElementById('confirmDeleteButton').addEventListener('click', () => {
                if (recordToProcess.type === 'employee') {
                    handleDeleteEmployee(recordToProcess.employeeIndex);
                } else if (recordToProcess.type === 'history') {
                    handleDeleteHistoryRecord(recordToProcess.historyIndex);
                } else if (recordToProcess.type === 'jobOwner') {
                    const owners = getRecords(storageKeys.jobOwners);
                    const updatedOwners = owners.filter(owner => owner.id !== recordToProcess.id);
                    saveRecords(storageKeys.jobOwners, updatedOwners);

                    const employers = getRecords(storageKeys.employers);
                    employers.forEach(emp => {
                        if (emp.jobOwnerId === recordToProcess.id) {
                            emp.jobOwnerId = '';
                        }
                    });
                    saveRecords(storageKeys.employers, employers);

                    renderJobOwnerDropdown();
                    document.getElementById('jobOwnerId').value = '';
                    document.getElementById('deleteJobOwnerBtn').disabled = true;
                    showSuccessMessage('ลบข้อมูลเจ้าของงานเรียบร้อยแล้ว');
                } else if (recordToProcess.type && recordToProcess.index !== -1) {
                    deleteSingleRecord(recordToProcess.type, recordToProcess.index);
                }
                modals.confirmDelete.hide();
                recordToProcess = { type: '', index: -1, employeeIndex: null, historyIndex: null, id: null };
            });
            
            document.body.addEventListener('click', function(e) {
                const cancelButton = e.target.closest('.cancel-form-btn');
                if (cancelButton) {
                    const parentModalEl = cancelButton.closest('.modal');
                    if (parentModalEl) {
                        activeFormModal = bootstrap.Modal.getInstance(parentModalEl);
                        if (activeFormModal) {
                            modals.confirmCancel.show();
                        }
                    }
                }
                
                const exportButton = e.target.closest('.export-btn');
                if (exportButton) {
                    handleExport(exportButton.dataset.exportType);
                }
            });

            document.getElementById('confirmCancelButton').addEventListener('click', function() {
                if (activeFormModal) {
                    activeFormModal.hide();
                }
                modals.confirmCancel.hide();
                activeFormModal = null;
            });

            document.getElementById('searchEmployerInput').addEventListener('input', (e) => renderTable('employers', e.target.value));
            document.getElementById('searchImporterInput').addEventListener('input', (e) => renderTable('importers', e.target.value));
            document.getElementById('searchAgentInput').addEventListener('input', (e) => renderTable('agents', e.target.value));
            document.getElementById('searchDelegateInput').addEventListener('input', (e) => renderTable('delegates', e.target.value));
            
            ['90day', 'passport', 'ci_renew', 'resolution_renew', 'cancelled_renew'].forEach(type => {
                const config = notificationConfig[type];
                if (!config.searchInputId) return; 
                const handler = () => {
                    currentPages[type] = 1;
                    renderNotifications(type);
               };
                document.getElementById(config.searchInputId).addEventListener('input', handler);
                // เพิ่มเงื่อนไขเช็คว่ามี searchMonthId หรือไม่ ก่อนจะ addEventListener
                if (config.searchMonthId) {
                    document.getElementById(config.searchMonthId).addEventListener('change', handler);
                }
                document.getElementById(config.searchNationalityId).addEventListener('change', handler);
                document.getElementById(config.searchMOUId).addEventListener('change', handler);

                // เพิ่มเงื่อนไขนี้เข้าไป
                if (type === 'resolution_renew') {
                    document.getElementById('search-resolution_renew-step').addEventListener('change', handler);
                }
            });

            const permitsSearchHandler = () => {
                currentPages.workPermit = 1;
                currentPages.visa = 1;
                currentPages.workPermitExpired = 1;
                renderNotifications('workPermit');
                renderNotifications('visa');
                renderNotifications('workPermitExpired');
            };
            const permitsConfig = notificationConfig.workPermit;
            document.getElementById(permitsConfig.searchInputId).addEventListener('input', permitsSearchHandler);
            document.getElementById(permitsConfig.searchMonthId).addEventListener('change', permitsSearchHandler);
            document.getElementById(permitsConfig.searchNationalityId).addEventListener('change', permitsSearchHandler);
            document.getElementById(permitsConfig.searchMOUId).addEventListener('change', permitsSearchHandler);


            document.getElementById('notificationTabContent').addEventListener('click', (e) => {
                const target = e.target.closest('.page-link');
                if (!target) return;
                
                e.preventDefault();
                if (target.parentElement.classList.contains('disabled') || target.parentElement.classList.contains('active')) return;

                const page = parseInt(target.dataset.page, 10);
                const type = target.dataset.type;
                currentPages[type] = page;
                renderNotifications(type);
            });

            const addrProvinceEl = document.getElementById('addrProvince');
            const addrDistrictEl = document.getElementById('addrDistrict');
            const addrSubDistrictEl = document.getElementById('addrSubDistrict');
            addrProvinceEl.addEventListener('change', () => {
                const provinceData = thaiAddressData.find(p => p.name_th === addrProvinceEl.value);
                document.getElementById('addrProvinceEn').value = provinceData?.name_en || '';
                populateDropdown(addrDistrictEl, provinceData?.amphure || [], 'เลือกอำเภอ');
                addrDistrictEl.dispatchEvent(new Event('change'));
            });
            addrDistrictEl.addEventListener('change', () => {
                const provinceData = thaiAddressData.find(p => p.name_th === addrProvinceEl.value);
                const districtData = provinceData?.amphure.find(a => a.name_th === addrDistrictEl.value);
                document.getElementById('addrDistrictEn').value = districtData?.name_en || '';
                populateDropdown(addrSubDistrictEl, districtData?.tambon || [], 'เลือกตำบล');
                addrSubDistrictEl.dispatchEvent(new Event('change'));
            });
            addrSubDistrictEl.addEventListener('change', () => {
                const provinceData = thaiAddressData.find(p => p.name_th === addrProvinceEl.value);
                const districtData = provinceData?.amphure.find(a => a.name_th === addrDistrictEl.value);
                const tambonData = districtData?.tambon.find(t => t.name_th === addrSubDistrictEl.value);
                document.getElementById('addrSubDistrictEn').value = tambonData?.name_en || '';
                document.getElementById('addrZipCode').value = tambonData?.zip_code || '';
            });

            const mainNavLinks = document.querySelectorAll('#main-nav .list-group-item');
            const contentPanes = document.querySelectorAll('.content-pane');
            mainNavLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const currentlyActive = document.querySelector('#main-nav .list-group-item.active');
                    if(currentlyActive) currentlyActive.classList.remove('active');
                    
                    this.classList.add('active');
                    const targetPaneId = this.getAttribute('href');

                    if (targetPaneId === '#dashboard-pane') {
                        renderDashboard();
                    } else if (targetPaneId === '#notification-pane') {
                        Object.keys(notificationConfig).forEach(type => {
                            currentPages[type] = 1;
                            renderNotifications(type)
                        });
                        const targetTabId = this.dataset.tabTarget;
                        if(targetTabId) {
                            const tabTrigger = document.getElementById(targetTabId);
                            if(tabTrigger) {
                                bootstrap.Tab.getOrCreateInstance(tabTrigger).show();
                            }
                        }
                    }

                    contentPanes.forEach(pane => {
                        pane.style.display = (`#${pane.id}` === targetPaneId) ? 'block' : 'none';
                    });
                });
            });

            const employeeTitleThEl = document.getElementById('employeeTitleTh');
            const employeeTitleEnEl = document.getElementById('employeeTitleEn');
            const titleMap = { "นาย": "Mr.", "นางสาว": "Miss", "นาง": "Mrs." };
            const reverseTitleMap = { "Mr.": "นาย", "Miss": "นางสาว", "Mrs.": "นาง" };

            employeeTitleThEl.addEventListener('change', () => {
                const correspondingEn = titleMap[employeeTitleThEl.value];
                if (correspondingEn) employeeTitleEnEl.value = correspondingEn;
            });

            employeeTitleEnEl.addEventListener('change', () => {
                const correspondingTh = reverseTitleMap[employeeTitleEnEl.value];
                if (correspondingTh) employeeTitleThEl.value = correspondingTh;
            });

            // Task Tracking Modal Listeners
            document.getElementById('saveTaskTrackingButton').addEventListener('click', saveTaskTrackingProgress);
            document.getElementById('taskTrackingStepsContainer').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const step = e.target.dataset.step;
                    const dateEl = document.getElementById(`step${step}_date`);
                    const itemEl = document.getElementById(`step${step}-item`);
                    if (e.target.checked) {
                        dateEl.value = getTodayDateString();
                        itemEl.classList.add('completed');
                    } else {
                        dateEl.value = '';
                        itemEl.classList.remove('completed');
                    }
                    checkAllStepsCompleted();
                }
            });
            document.getElementById('triggerRenewButton').addEventListener('click', () => {
                const employerIndex = document.getElementById('taskTrackingEmployerIndex').value;
                const employeeIndex = document.getElementById('taskTrackingEmployeeIndex').value;
                modals.taskTracking.hide();
                openRenewModal('resolution_renew', employerIndex, employeeIndex);
            });

            // Set default active pane
            document.querySelector('#main-nav .list-group-item.active').click();
        });
    </script>
</body>
</html>